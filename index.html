<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TaskChute Pro (Supabase Sync)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <!-- ✅ Supabase JS (UMD) : window.supabase が必ず生える版 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@300;400;500;700&display=swap');
    body { font-family: 'Inter','Noto Sans JP',sans-serif; background-color:#f8fafc; }

    .status-running { border-left:4px solid #3b82f6; background:#eff6ff; }
    .status-paused { border-left:4px solid #f59e0b; background:#fffbeb; }
    .status-completed { border-left:4px solid #10b981; background:#ecfdf5; opacity:0.75; }
    .status-pending { border-left:4px solid #cbd5e1; background:white; }
    .status-future { border-left:4px solid #94a3b8; background:#f1f5f9; opacity:0.9; }

    #sidebar-overlay.hidden{
      display: none !important;
      pointer-events: none !important;
      opacity: 0 !important;
    }

    .custom-scroll::-webkit-scrollbar { width:6px; }
    .custom-scroll::-webkit-scrollbar-track { background:#f1f1f1; }
    .custom-scroll::-webkit-scrollbar-thumb { background:#cbd5e1; border-radius:10px; }

    .modal-bg { background-color: rgba(0,0,0,0.4); backdrop-filter: blur(2px); }
    .tab-active { border-bottom:3px solid #2563eb; color:#2563eb; font-weight:800; }

    .sidebar-transition { transition: transform 0.3s ease-in-out; }
    @media (max-width:1024px){
      .sidebar-hidden { transform: translateX(-100%); }
      .sidebar-overlay { display:none; }
      .sidebar-open .sidebar-overlay { display:block; }
    }

    .fab { position:fixed; bottom:2rem; right:2rem; z-index:40; }
    .view-btn.active { background:#3b82f6; color:white; }

    @media (min-width:1025px){
      .task-card:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
      .task-actions { opacity:0; transition: opacity 0.2s; }
      .task-card:hover .task-actions { opacity:1; }
    }

    .scrollbar-hide::-webkit-scrollbar{ display:none; }
    .scrollbar-hide{ -ms-overflow-style:none; scrollbar-width:none; }

    .toast { position: fixed; left: 50%; transform: translateX(-50%); bottom: 1.25rem; z-index: 60; }
  </style>
</head>
<body class="h-screen overflow-hidden flex flex-col text-slate-900">

  <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/20 backdrop-blur-sm z-10 hidden sidebar-overlay"></div>

  <header class="bg-white border-b px-4 py-3 flex justify-between items-center shadow-sm z-30">
    <div class="flex items-center gap-3">
      <button onclick="toggleSidebar()" class="p-2 hover:bg-slate-100 rounded-lg lg:hidden" aria-label="menu">
        <i class="fas fa-bars text-xl text-slate-600"></i>
      </button>
      <div class="bg-blue-600 p-2 rounded-lg"><i class="fas fa-clock text-white text-lg"></i></div>
      <div>
        <h1 class="font-bold text-lg tracking-tight">TaskChute <span class="text-blue-600">Pro</span></h1>
        <p class="text-[10px] text-slate-500">最終終了予定: <span id="finish-estimate" class="font-semibold text-blue-600">--:--</span></p>
      </div>
    </div>

    <div class="flex items-center gap-3">
      <div class="hidden sm:flex bg-slate-100 p-1 rounded-lg">
        <button onclick="setDateRange('today')" id="btn-today" class="view-btn px-4 py-1.5 text-xs font-bold rounded-md transition active">今日</button>
        <button onclick="setDateRange('rolling7')" id="btn-rolling7" class="view-btn px-4 py-1.5 text-xs font-bold rounded-md transition text-slate-500">直近7日</button>
        <button onclick="setDateRange('week')" id="btn-week" class="view-btn px-4 py-1.5 text-xs font-bold rounded-md transition text-slate-500">今週</button>
        <button onclick="setDateRange('month')" id="btn-month" class="view-btn px-4 py-1.5 text-xs font-bold rounded-md transition text-slate-500">今月</button>
        <button onclick="setDateRange('undated')" id="btn-undated" class="view-btn px-4 py-1.5 text-xs font-bold rounded-md transition text-slate-500">未設定</button>
      <button onclick="openQuickSearch()" class="p-2 hover:bg-slate-100 rounded-lg" aria-label="search">
        <i class="fas fa-magnifying-glass text-slate-600"></i>
      </button>

      <button id="auth-chip" onclick="openAuthModal()" class="hidden sm:flex items-center gap-2 px-3 py-2 rounded-xl border hover:bg-slate-50 text-xs font-bold text-slate-700" aria-label="auth">
        <i class="fas fa-user"></i>
        <span id="auth-label">未ログイン</span>
      </button>
    </div>
  </header>

  <div class="flex-1 flex overflow-hidden relative">

    <aside id="sidebar" class="w-72 bg-white border-r flex flex-col fixed inset-y-0 left-0 z-20 sidebar-transition sidebar-hidden lg:relative lg:translate-x-0">
      <div class="flex border-b text-center text-[11px] font-bold uppercase tracking-wider text-slate-400">
        <button onclick="switchSidebarTab('plan')" id="tab-plan" class="flex-1 py-4 tab-active">表示設定</button>
        <button onclick="switchSidebarTab('sync')" id="tab-sync" class="flex-1 py-4">同期・管理</button>
      </div>

      <div id="sidebar-content" class="flex-1 overflow-y-auto custom-scroll p-4 space-y-6">

        <div id="view-plan" class="space-y-6">
          <section>
            <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">表示フィルタ</h3>
            <div class="space-y-3 bg-slate-50 p-3 rounded-xl border border-slate-100">
              <label class="flex items-center justify-between cursor-pointer">
                <span class="text-xs font-bold text-slate-600">完了済みを表示</span>
                <input type="checkbox" id="filter-completed" checked onchange="renderAll()" class="w-4 h-4 accent-blue-600" />
              </label>
              <label class="flex items-center justify-between cursor-pointer pt-2 border-t">
                <span class="text-xs font-bold text-slate-600">全未完了を表示</span>
                <input type="checkbox" id="filter-uncompleted-only" onchange="renderAll()" class="w-4 h-4 accent-red-600" />
              </label>
            </div>
          </section>

          <section>
            <div class="flex justify-between items-center mb-3">
              <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest">プロジェクト</h3>
              <button onclick="openProjectModal()" class="text-blue-600 hover:text-blue-700 transition" aria-label="add project">
                <i class="fas fa-plus-circle"></i>
              </button>
            </div>
            <div id="project-list" class="space-y-1"></div>
            <div class="mt-2">
              <button onclick="setProjectFilter(null)" class="w-full text-[10px] font-bold py-2 rounded-lg bg-slate-50 hover:bg-slate-100 border text-slate-600">フィルタ解除</button>
            </div>
          </section>

          <section>
            <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">保存方式</h3>
            <div class="bg-slate-50 p-3 rounded-xl border border-slate-100 space-y-2">
              <div class="text-[11px] text-slate-600 leading-relaxed">
                この版は <b>Supabase（ログイン必須）</b> でPC/スマホ同期します。ログインしていない場合は <b>LocalStorage</b> に退避します。
              </div>
              <div class="flex items-center justify-between">
                <span class="text-xs font-bold text-slate-600">現在: <span id="storage-mode">---</span></span>
                <button onclick="openAuthModal()" class="text-xs font-bold text-blue-600 hover:text-blue-700">ログイン</button>
              </div>
            </div>
          </section>
        </div>

        <div id="view-sync" class="hidden p-4 space-y-4">
          <button onclick="openLocalBackups()" class="w-full bg-slate-100 text-slate-600 text-[10px] font-bold py-2 rounded-lg hover:bg-slate-200 transition">世代バックアップ（端末内）</button>
          <button onclick="exportToCSV()" class="w-full bg-slate-100 text-slate-600 text-[10px] font-bold py-2 rounded-lg hover:bg-slate-200 transition">CSV出力</button>
          <button onclick="backupJSON()" class="w-full bg-slate-100 text-slate-600 text-[10px] font-bold py-2 rounded-lg hover:bg-slate-200 transition">JSONバックアップ</button>
          <label class="block">
            <span class="text-[10px] font-bold text-slate-500">JSON復元</span>
            <input type="file" accept="application/json" onchange="restoreJSON(event)" class="mt-1 w-full text-xs" />
          </label>
          <button onclick="clearData()" class="w-full bg-red-50 text-red-600 text-[10px] font-bold py-2 rounded-lg hover:bg-red-100 transition">全データ消去</button>

          <div class="pt-2 border-t">
            <p class="text-[10px] font-bold text-slate-500 mb-2">デバッグ</p>
            <button onclick="runTests()" class="w-full bg-slate-900 text-white text-[10px] font-bold py-2 rounded-lg hover:bg-slate-800 transition">簡易テスト実行</button>
          </div>
        </div>

      </div>
    </aside>

    <main class="flex-1 flex flex-col bg-slate-50 relative overflow-hidden">
      <div class="p-3 flex gap-3 bg-white border-b overflow-x-auto whitespace-nowrap scrollbar-hide">
        <div class="flex-1 min-w-[120px] bg-slate-50 p-2 rounded-lg border text-center">
          <p class="text-[9px] text-slate-400 font-bold mb-0.5">見積合計</p>
          <p class="text-sm font-bold" id="total-estimate">0h 00m</p>
        </div>
        <div class="flex-1 min-w-[120px] bg-slate-50 p-2 rounded-lg border text-center">
          <p class="text-[9px] text-slate-400 font-bold mb-0.5">実績合計</p>
          <p class="text-sm font-bold" id="total-actual">0h 00m</p>
        </div>
        <div class="flex-1 min-w-[120px] bg-slate-50 p-2 rounded-lg border text-center">
          <p class="text-[9px] text-slate-400 font-bold mb-0.5">未設定タスク</p>
          <p class="text-sm font-bold" id="undated-count">0</p>
        </div>
        <div class="flex-1 min-w-[120px] bg-slate-50 p-2 rounded-lg border text-center">
          <p class="text-[9px] text-slate-400 font-bold mb-0.5">割り込み件数</p>
          <p class="text-sm font-bold text-rose-600" id="interrupt-count">0</p>
        </div>
      </div>

      <div class="flex-1 overflow-y-auto custom-scroll p-4 md:px-12 py-8 max-w-5xl mx-auto w-full">
        <div class="sm:hidden flex bg-slate-100 p-1 rounded-lg mb-5">
          <button onclick="setDateRange('today')" id="btn-today-m" class="view-btn w-1/4 px-2 py-1.5 text-xs font-bold rounded-md transition active">今日</button>
          <button onclick="setDateRange('rolling7')" id="btn-rolling7-m" class="view-btn w-1/4 px-2 py-1.5 text-xs font-bold rounded-md transition text-slate-500">直近7日</button>
          <button onclick="setDateRange('week')" id="btn-week-m" class="view-btn w-1/4 px-2 py-1.5 text-xs font-bold rounded-md transition text-slate-500">今週</button>
          <button onclick="setDateRange('month')" id="btn-month-m" class="view-btn w-1/5 px-2 py-1.5 text-xs font-bold rounded-md transition text-slate-500">今月</button>
          <button onclick="setDateRange('undated')" id="btn-undated-m" class="view-btn w-1/4 px-2 py-1.5 text-xs font-bold rounded-md transition text-slate-500">未設定</button>
        </div>
        <button onclick="openTaskModal(null, true)" class="w-full mb-8 py-4 bg-white border-2 border-dashed border-rose-200 text-rose-500 rounded-2xl text-xs font-black tracking-widest hover:bg-rose-50 transition flex items-center justify-center gap-2 shadow-sm">
          <i class="fas fa-bolt"></i> 割り込みタスクを追加
        </button>

        <div id="task-container"></div>
      </div>

      <button onclick="openTaskModal()" class="fab w-16 h-16 bg-blue-600 text-white rounded-full shadow-2xl flex items-center justify-center text-2xl hover:bg-blue-700 transition transform hover:scale-105 active:scale-95" aria-label="add task">
        <i class="fas fa-plus"></i>
      </button>
    </main>
  </div>

  <!-- Task Modal -->
  <div id="task-modal" class="fixed inset-0 modal-bg z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl w-full max-w-lg shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
      <div class="p-6 border-b flex justify-between items-center hookup bg-slate-50">
        <h3 class="text-xl font-bold text-slate-800" id="modal-title">タスク詳細</h3>
        <button onclick="closeModal('task-modal')" class="text-slate-400 p-2 hover:bg-slate-200 rounded-full" aria-label="close"><i class="fas fa-times"></i></button>
      </div>

      <div class="p-6 md:p-8 space-y-5 overflow-y-auto custom-scroll" id="task-modal-body">
        <input type="hidden" id="task-id" />
        <input type="hidden" id="task-is-interrupt" />

        <div class="space-y-2">
          <label class="block text-[11px] font-black text-slate-400 uppercase tracking-widest">タスク名</label>
          <input type="text" id="task-name" class="w-full border-2 border-slate-100 rounded-2xl p-4 outline-none focus:border-blue-500 bg-slate-50 font-bold" placeholder="何をしますか？" />
        </div>

        <div class="grid grid-cols-2 gap-4 md:gap-6">
          <div class="space-y-2">
            <label class="block text-[11px] font-black text-slate-400 uppercase tracking-widest">時間枠 (セクション)</label>
            <select id="task-section" class="w-full border-2 border-slate-100 rounded-2xl p-4 bg-slate-50 text-sm outline-none focus:border-blue-500"></select>
          </div>
          <div class="space-y-2">
            <label class="block text-[11px] font-black text-slate-400 uppercase tracking-widest">プロジェクト</label>
            <select id="task-project" class="w-full border-2 border-slate-100 rounded-2xl p-4 bg-slate-50 text-sm outline-none focus:border-blue-500"></select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4 md:gap-6">
          <div class="space-y-2">
            <label class="block text-[11px] font-black text-slate-400 uppercase tracking-widest">見積 (分)</label>
            <input type="number" id="task-duration" min="0" class="w-full border-2 border-slate-100 rounded-2xl p-4 bg-slate-50 text-sm outline-none" placeholder="例: 25" />
          </div>
          <div class="space-y-2">
            <label class="block text-[11px] font-black text-slate-400 uppercase tracking-widest">実行予定日</label>
            <input type="date" id="task-deadline" class="w-full border-2 border-slate-100 rounded-2xl p-4 bg-slate-50 text-sm outline-none" />
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4 md:gap-6">
          <div class="space-y-2">
            <label class="block text-[11px] font-black text-slate-400 uppercase tracking-widest">リピート</label>
            <select id="task-repeat" class="w-full border-2 border-slate-100 rounded-2xl p-4 bg-slate-50 text-sm outline-none focus:border-blue-500">
              <option value="none">なし</option>
              <option value="daily">毎日</option>
              <option value="weekday">平日</option>
              <option value="weekly">毎週</option>
              <option value="monthly">毎月</option>
            </select>
          </div>
          <div class="space-y-2">
            <label class="block text-[11px] font-black text-slate-400 uppercase tracking-widest">ステータス</label>
            <select id="task-status" class="w-full border-2 border-slate-100 rounded-2xl p-4 bg-slate-50 text-sm outline-none focus:border-blue-500">
              <option value="pending">未着手</option>
              <option value="running">実行中</option>
              <option value="paused">中断</option>
              <option value="completed">完了</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4 md:gap-6">
          <div class="space-y-2">
            <label class="block text-[11px] font-black text-slate-400 uppercase tracking-widest">実績 (分)</label>
            <input type="number" id="task-actual" min="0" class="w-full border-2 border-slate-100 rounded-2xl p-4 bg-slate-50 text-sm outline-none" placeholder="例: 30" />
          </div>
          <div class="space-y-2">
            <label class="block text-[11px] font-black text-slate-400 uppercase tracking-widest">優先度</label>
            <select id="task-priority" class="w-full border-2 border-slate-100 rounded-2xl p-4 bg-slate-50 text-sm outline-none focus:border-blue-500">
              <option value="3">通常</option>
              <option value="2">やや高</option>
              <option value="1">高</option>
              <option value="4">低</option>
            </select>
          </div>
        </div>

        <div class="space-y-2">
          <label class="block text-[11px] font-black text-slate-400 uppercase tracking-widest">備考（必須）</label>
          <textarea id="task-notes" rows="4" class="w-full border-2 border-slate-100 rounded-2xl p-4 outline-none focus:border-blue-500 bg-slate-50 text-sm" placeholder="作業条件、判断メモ、気づき…（空は保存できません）"></textarea>
          <p class="text-[11px] text-slate-500">※「備考必須」ルールで、空欄のまま保存できません。</p>
        </div>

        <div class="flex gap-3 pt-2">
          <button onclick="saveTaskFromModal()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-2xl">保存</button>
          <button onclick="closeModal('task-modal')" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-3 rounded-2xl">キャンセル</button>
        </div>

        <!-- ✅ ここから: 一覧から移した操作（削除/先送り/ループ） -->
        <div class="pt-6 mt-2 border-t space-y-3">
          <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">操作</p>
          <div class="grid grid-cols-2 gap-3">
            <button id="modal-postpone-btn"
              onclick="postponeTaskFromModal(1)"
              class="bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-3 rounded-2xl text-sm">
              <i class="fas fa-forward mr-1"></i> 先送り（+1日）
            </button>
            <button id="modal-loop-btn"
              onclick="loopTaskFromModal()"
              class="bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-3 rounded-2xl text-sm">
              <i class="fas fa-rotate-right mr-1"></i> ループ
            </button>
          </div>
          <button id="modal-delete-btn"
            onclick="deleteTaskFromModal()"
            class="w-full bg-red-50 hover:bg-red-100 text-red-700 font-black py-3 rounded-2xl text-sm">
            <i class="fas fa-trash mr-1"></i> このタスクを削除
          </button>
          <p class="text-[11px] text-slate-500">※削除は取り消せません。必要なら先送りで逃がすのが安全です。</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Project Modal -->
  <div id="project-modal" class="fixed inset-0 modal-bg z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl w-full max-w-md shadow-2xl overflow-hidden">
      <div class="p-6 border-b flex justify-between items-center bg-slate-50">
        <h3 class="text-lg font-bold text-slate-800">プロジェクト</h3>
        <button onclick="closeModal('project-modal')" class="text-slate-400 p-2 hover:bg-slate-200 rounded-full" aria-label="close"><i class="fas fa-times"></i></button>
      </div>
      <div class="p-6 space-y-4">
        <input type="hidden" id="project-id" />
        <div class="space-y-2">
          <label class="block text-[11px] font-black text-slate-400 uppercase tracking-widest">名称</label>
          <input type="text" id="project-name" class="w-full border-2 border-slate-100 rounded-2xl p-4 outline-none focus:border-blue-500 bg-slate-50 font-bold" placeholder="例: 情シス改善" />
        </div>
        <div class="flex gap-3">
          <button onclick="saveProjectFromModal()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-2xl">保存</button>
          <button onclick="closeModal('project-modal')" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-3 rounded-2xl">閉じる</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Search Modal -->
  <div id="search-modal" class="fixed inset-0 modal-bg z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl w-full max-w-lg shadow-2xl overflow-hidden">
      <div class="p-6 border-b flex justify-between items-center bg-slate-50">
        <h3 class="text-lg font-bold text-slate-800">検索</h3>
        <button onclick="closeModal('search-modal')" class="text-slate-400 p-2 hover:bg-slate-200 rounded-full" aria-label="close"><i class="fas fa-times"></i></button>
      </div>
      <div class="p-6 space-y-3">
        <input id="search-q" oninput="renderAll()" type="text" class="w-full border-2 border-slate-100 rounded-2xl p-4 outline-none focus:border-blue-500 bg-slate-50" placeholder="タスク名 / 備考 / プロジェクト…" />
        <p class="text-[11px] text-slate-500">ESCで閉じます</p>
      </div>
    </div>
  </div>

  <!-- Auth Modal -->
  <div id="auth-modal" class="fixed inset-0 modal-bg z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl w-full max-w-md shadow-2xl overflow-hidden">
      <div class="p-6 border-b flex justify-between items-center bg-slate-50">
        <h3 class="text-lg font-bold text-slate-800">ログイン</h3>
        <button onclick="closeModal('auth-modal')" class="text-slate-400 p-2 hover:bg-slate-200 rounded-full" aria-label="close"><i class="fas fa-times"></i></button>
      </div>
      <div class="p-6 space-y-4">
        <div class="text-[12px] text-slate-600 leading-relaxed">
          PC/スマホで同期するため、Supabaseでログインします。<br />
          既存データが端末内にある場合は、ログイン後に「クラウドへ移行」できます。
        </div>

        <div class="space-y-2">
          <label class="block text-[11px] font-black text-slate-400 uppercase tracking-widest">Email</label>
          <input id="auth-email" type="email" class="w-full border-2 border-slate-100 rounded-2xl p-4 outline-none focus:border-blue-500 bg-slate-50" placeholder="you@example.com" />
        </div>

        <div class="space-y-2">
          <label class="block text-[11px] font-black text-slate-400 uppercase tracking-widest">Password</label>
          <input id="auth-pass" type="password" class="w-full border-2 border-slate-100 rounded-2xl p-4 outline-none focus:border-blue-500 bg-slate-50" placeholder="password" />
          <p class="text-[11px] text-slate-500">初回は「新規登録」で作れます</p>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <button onclick="authSignIn()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-2xl">ログイン</button>
          <button onclick="authSignUp()" class="bg-slate-900 hover:bg-slate-800 text-white font-bold py-3 rounded-2xl">新規登録</button>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <button onclick="migrateLocalToCloud()" class="bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-3 rounded-2xl">クラウドへ移行</button>
          <button onclick="authSignOut()" class="bg-red-50 hover:bg-red-100 text-red-700 font-bold py-3 rounded-2xl">ログアウト</button>
        </div>

        <div class="text-[11px] text-slate-500">
          現在の保存: <b id="auth-storage">---</b>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast hidden"><div class="bg-slate-900 text-white text-sm px-4 py-2 rounded-xl shadow-xl"></div></div>

<script>
(function(){
  'use strict';

  /*********************
   * App version
   *********************/
  var APP_VERSION = '1.2.0'; // ← ここをリリースごとに更新

  function setAppVersionUI(){
    var el = document.getElementById('app-version');
    if (el) el.textContent = 'v' + APP_VERSION;
  }

/*********************
 * 0) Supabase config（ここを置換）
 *********************/
var SUPABASE_URL = 'https://opjgyixsmdbnmkwbxruy.supabase.co';
var SUPABASE_ANON_KEY = 'sb_publishable_hQMgGP5NXKYOZUYf8938Jw_5MzJMhWA';

// ✅ デバッグ用に必ず window へ「状態」を出す
window.__TASKCHUTE_SUPABASE = window.__TASKCHUTE_SUPABASE || {};
window.__TASKCHUTE_SUPABASE.url = SUPABASE_URL;
window.__TASKCHUTE_SUPABASE.hasWindowSupabase = !!window.supabase;
window.__TASKCHUTE_SUPABASE.hasCreateClient = !!(window.supabase && window.supabase.createClient);

var supabaseClient = null;

try {
  if (!window.supabase || typeof window.supabase.createClient !== 'function') {
    throw new Error('Supabase UMD not loaded or createClient missing');
  }

  // ✅ 以前のクライアントがあれば再利用
  supabaseClient = window.__TASKCHUTE_SUPABASE_CLIENT || null;

  if (!supabaseClient) {
    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    window.__TASKCHUTE_SUPABASE_CLIENT = supabaseClient;  // ★必ず入れる
  }

  // ✅ Console から触れるように別名も公開（任意だけど便利）
  window.supabaseClient = supabaseClient;

  window.__TASKCHUTE_SUPABASE.ready = true;
} catch (e) {
  console.error('Supabase init failed:', e);
  window.__TASKCHUTE_SUPABASE.ready = false;
  window.__TASKCHUTE_SUPABASE.error = String(e && e.message ? e.message : e);
  supabaseClient = null;
}

  /*********************
   * 1) Storage adapters
   *********************/
  var STORAGE_KEY = 'taskchute_pro_v1_local';

  function LocalStorageAdapter(){}
  LocalStorageAdapter.prototype.load = async function(){
    var raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return null;
    try { return JSON.parse(raw); } catch { return null; }
  };
  LocalStorageAdapter.prototype.save = async function(data){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  };
  LocalStorageAdapter.prototype.clear = async function(){
    localStorage.removeItem(STORAGE_KEY);
  };

  function SupabaseAdapter(client){ this.client = client; }
  SupabaseAdapter.prototype.load = async function(){
    if (!this.client) return null;
    var sessionData = await this.client.auth.getSession();
    var user = sessionData && sessionData.data && sessionData.data.session && sessionData.data.session.user;
    if (!user) return null;

    var res = await this.client.from('user_data').select('data').eq('user_id', user.id).maybeSingle();
    if (res.error) throw res.error;
    return (res.data && res.data.data) ? res.data.data : null;
  };
  SupabaseAdapter.prototype.save = async function(stateData){
    if (!this.client) return;
    var sessionData = await this.client.auth.getSession();
    var user = sessionData && sessionData.data && sessionData.data.session && sessionData.data.session.user;
    if (!user) throw new Error('not authenticated');

    var res = await this.client.from('user_data')
      .upsert({ user_id: user.id, data: stateData, updated_at: new Date().toISOString() }, { onConflict: 'user_id' });
    if (res.error) throw res.error;
  };
  SupabaseAdapter.prototype.clear = async function(){
    if (!this.client) return;
    var sessionData = await this.client.auth.getSession();
    var user = sessionData && sessionData.data && sessionData.data.session && sessionData.data.session.user;
    if (!user) return;

    var res = await this.client.from('user_data').delete().eq('user_id', user.id);
    if (res.error) throw res.error;
  };

  function HybridAdapter(local, cloud, client){
    this.local = local;
    this.cloud = cloud;
    this.client = client;
  }
  HybridAdapter.prototype.isAuthed = async function(){
    if (!this.client) return false;
    var s = await this.client.auth.getSession();
    return !!(s && s.data && s.data.session && s.data.session.user);
  };
  HybridAdapter.prototype.load = async function(){
    if (await this.isAuthed()) { setStorageModeUI('Supabase'); return await this.cloud.load(); }
    setStorageModeUI('LocalStorage');
    return await this.local.load();
  };
  HybridAdapter.prototype.save = async function(data){
    if (await this.isAuthed()) { setStorageModeUI('Supabase'); return await this.cloud.save(data); }
    setStorageModeUI('LocalStorage');
    return await this.local.save(data);
  };
  HybridAdapter.prototype.clear = async function(){
    if (await this.isAuthed()) { setStorageModeUI('Supabase'); return await this.cloud.clear(); }
    setStorageModeUI('LocalStorage');
    return await this.local.clear();
  };

  var localAdapter = new LocalStorageAdapter();
  var cloudAdapter = new SupabaseAdapter(supabaseClient);
  var storage = new HybridAdapter(localAdapter, cloudAdapter, supabaseClient);

  /*********************
   * 2) Utils
   *********************/
  function nowISODate(){ return new Date().toISOString().slice(0,10); }
    function uid(){
  var c = (typeof crypto !== 'undefined') ? crypto : null;
  return (c && c.randomUUID) ? c.randomUUID()
   : (Date.now().toString(36) + Math.random().toString(36).slice(2));
  }
  var DAYTIME_SECTIONS = new Set(['forenoon','afternoon']); // 午前・午後だけ
  function isAfterEveningCutoff(dateObj){
  var h = dateObj.getHours();
  var m = dateObj.getMinutes();
  return (h > 18) || (h === 18 && m >= 40); // ← ここを18:40に設定
}
  function addDaysISO(iso, days){
    var d = new Date(iso + 'T00:00:00');
    d.setDate(d.getDate() + days);
    var y = d.getFullYear();
    var mo = String(d.getMonth()+1).padStart(2,'0');
    var da = String(d.getDate()).padStart(2,'0');
    return y + '-' + mo + '-' + da;
  }

  function setStorageModeUI(mode){
    var el = document.getElementById('storage-mode');
    var el2 = document.getElementById('auth-storage');
    if (el) el.textContent = mode;
    if (el2) el2.textContent = mode;
  }

  function toast(msg){
    var root = document.getElementById('toast');
    var box = root.querySelector('div');
    box.textContent = msg;
    root.classList.remove('hidden');
    setTimeout(function(){ root.classList.add('hidden'); }, 1800);
  }

  function escapeHtml(str){
    return String(str ?? '')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#39;');
  }

  function fmtMin(min){
    var m = Number(min)||0;
    var h = Math.floor(m/60);
    var mm = m%60;
    return h + 'h ' + String(mm).padStart(2,'0') + 'm';
  }

  function prettyDate(iso){
    try {
      var d = new Date(iso + 'T00:00:00');
      var w = ['日','月','火','水','木','金','土'][d.getDay()];
      return d.getFullYear() + '/' + String(d.getMonth()+1).padStart(2,'0') + '/' + String(d.getDate()).padStart(2,'0') + ' (' + w + ')';
    } catch {
      return iso;
    }
  }

  function elapsedMinSince(iso){
    if (!iso) return 0;
    var start = new Date(iso).getTime();
    if (!Number.isFinite(start)) return 0;
    var diffMs = Date.now() - start;
    return Math.max(0, Math.floor(diffMs / 60000));
  }

  function statusRank(s){
  return ({ completed: 4, running: 3, paused: 2, pending: 1 }[s] || 0);
}
function ts(x){
  var t = Date.parse(x || '');
  return Number.isFinite(t) ? t : 0;
}
function mergeTask(localT, cloudT){
  if (!localT) return cloudT;
  if (!cloudT) return localT;

  var lt = ts(localT.updatedAt);
  var ct = ts(cloudT.updatedAt);

  if (lt > ct) return localT;
  if (ct > lt) return cloudT;

  // 同一(or 判定不能)なら status でタイブレーク
  var ls = statusRank(localT.status);
  var cs = statusRank(cloudT.status);
  var chosen = (ls >= cs) ? localT : cloudT;

  // running 採用時の整合
  if (chosen.status === 'running'){
    if (!chosen.startedAt){
      chosen.startedAt = (localT.startedAt || cloudT.startedAt || new Date().toISOString());
    } else {
      var a = ts(localT.startedAt), b = ts(cloudT.startedAt);
      if (a && b) chosen.startedAt = (a <= b) ? localT.startedAt : cloudT.startedAt;
    }
  }
  return chosen;
}
 
  /*********************
   * 3) Sections + time windows
   *********************/
  var DEFAULT_SECTIONS = [
    { id: 'morning', name: '朝' },
    { id: 'forenoon', name: '午前' },
    { id: 'afternoon', name: '午後' },
    { id: 'evening', name: '夜' },
  ];

  var SECTION_BOUNDARIES_MIN = {
    morningStart: 5 * 60,
    forenoonStart: 9 * 60 + 30,
    afternoonStart: 13 * 60,
    eveningStart: 18 * 60 + 30,
  };

  function classifyTimeToSectionId(dateObj){
    var t = dateObj.getHours() * 60 + dateObj.getMinutes();
    if (t >= SECTION_BOUNDARIES_MIN.eveningStart || t < SECTION_BOUNDARIES_MIN.morningStart) return 'evening';
    if (t >= SECTION_BOUNDARIES_MIN.afternoonStart) return 'afternoon';
    if (t >= SECTION_BOUNDARIES_MIN.forenoonStart) return 'forenoon';
    return 'morning';
  }

  /*********************
   * 4) State (varでTDZ回避)
   *********************/
  var state = {
    data: {
      meta: { version: 1, updatedAt: new Date().toISOString() },
      projects: [ { id: 'inbox', name: 'INBOX' } ],
      sections: DEFAULT_SECTIONS,
      tasks: [],
      ui: { dateRange: 'today', projectFilter: null }
    }
  };

  function normalizeData(d){
    var safe = (d && typeof d === 'object') ? d : {};
    var projects = Array.isArray(safe.projects) ? safe.projects : [ {id:'inbox', name:'INBOX'} ];
    var sections = Array.isArray(safe.sections) ? safe.sections : DEFAULT_SECTIONS;
    var tasks = Array.isArray(safe.tasks) ? safe.tasks : [];
    var ui = (safe.ui && typeof safe.ui === 'object') ? safe.ui : { dateRange:'today', projectFilter:null };
    return { meta: { version: 1, updatedAt: new Date().toISOString() }, projects: projects, sections: sections, tasks: tasks, ui: ui };
  }

/*********************
 * 4.5) Persist Safety 
 *********************/

// 世代バックアップ設定
var BACKUP_PREFIX = 'taskchute_backup_';

// デバウンス＆ログイン直後クールダウン
var PERSIST_DEBOUNCE_MS = 500;   // 300〜800msで調整OK
var LOGIN_COOLDOWN_MS  = 1500;  // ログイン直後に保存しない

var _persistTimer = null;
var _cooldownUntil = 0;
var _persistInFlight = false;
var _dirtyWhileInFlight = false;
var __TEST_MODE__ = false;

function startLoginCooldown(){
  _cooldownUntil = Date.now() + LOGIN_COOLDOWN_MS;
}

// サンプル/空データ判定（事故防止）
function isSampleOrEmpty(){
  var tasks = state.data.tasks || [];
  if (tasks.length === 0) return true;
  if (tasks.length === 1) {
    var name = String(tasks[0].name || '');
    if (name.includes('（例）') || name.includes('例') || name.toLowerCase().includes('sample')) return true;
  }
  return false;
}

// backup key生成: taskchute_backup_20260205_054437
function makeBackupKey(ts){
  ts = ts || new Date();
  function pad(n){ return String(n).padStart(2,'0'); }
  var y = ts.getFullYear();
  var m = pad(ts.getMonth()+1);
  var d = pad(ts.getDate());
  var hh = pad(ts.getHours());
  var mm = pad(ts.getMinutes());
  var ss = pad(ts.getSeconds());
  return BACKUP_PREFIX + y + m + d + '_' + hh + mm + ss;
}

function listBackupKeys(){
  var keys = [];
  for (var i=0;i<localStorage.length;i++){
    var k = localStorage.key(i);
    if (k && k.startsWith(BACKUP_PREFIX)) keys.push(k);
  }
  keys.sort().reverse(); // 新しい順
  return keys;
}


// バックアップ合計サイズ上限（目安：2MB）
var MAX_BACKUP_TOTAL_BYTES = 2 * 1024 * 1024; // 2,097,152 bytes

function estimateBytes(str){
  // UTF-16 の概算（localStorageは実装差あるけど、概算としては十分）
  return (str ? str.length : 0) * 2;
}

function pruneBackupsByTotalSize(){
  var keys = listBackupKeys(); // 新しい順（あなたの実装：sort().reverse()）
  var total = 0;

  for (var i = 0; i < keys.length; i++){
    var k = keys[i];
    var v = localStorage.getItem(k) || '';
    total += estimateBytes(v);

    // 新しい方から足していって、上限を超えたら「古い方」を消す
    if (total > MAX_BACKUP_TOTAL_BYTES){
      // ここ以降は全部削除（i 以降はより古い）
      for (var j = i; j < keys.length; j++){
        localStorage.removeItem(keys[j]);
      }
      break;
    }
  }
}

// 上書き前に「直前のメイン」を退避（中身は同じ、pruneだけ差し替え）
function backupBeforeOverwrite(){
  var current = localStorage.getItem(STORAGE_KEY);
  if (!current) return;

  localStorage.setItem(makeBackupKey(new Date()), current);
  pruneBackupsByTotalSize();
}

// デバウンス入口：UIは即反映、保存はまとめる
function schedulePersist(reason){
  reason = reason || '';
  if (_persistTimer) clearTimeout(_persistTimer);
  _persistTimer = setTimeout(function(){
    _persistTimer = null;
    persistNow({reason: reason, fromDebounce:true});
  }, PERSIST_DEBOUNCE_MS);
}

/** ★ここを persistNow の外へ移動（重要） */
function parseUpdatedAt(data){
  try {
    var t = data && data.meta && data.meta.updatedAt ? Date.parse(data.meta.updatedAt) : 0;
    return Number.isFinite(t) ? t : 0;
  } catch {
    return 0;
  }
}

  // meta.updatedAt ではなく「タスクの更新時刻」で鮮度を取る（normalizeDataの影響を受けにくい）
function computeDataTimeByTasks(data){
  try {
    if (!data || !Array.isArray(data.tasks)) return 0;
    var max = 0;
    for (var i=0; i<data.tasks.length; i++){
      var t = data.tasks[i];
      var tt = Date.parse((t && t.updatedAt) ? t.updatedAt : '');
      if (Number.isFinite(tt) && tt > max) max = tt;
    }
    return max;
  } catch(e){
    return 0;
  }
}

/** ★ここも persistNow の外へ移動（重要） */
async function reconcileLocalAndCloud(){
  var local = await localAdapter.load();
  var cloud = null;
  var isAuthed = false;
  var cloudLoadOk = false;

  // ✅ ローカルは常に正規化（supabaseの有無に依存しない）
  var localNorm = local ? normalizeData(local) : null;

  if (supabaseClient){
    var s = await supabaseClient.auth.getSession();
    var user = s && s.data && s.data.session && s.data.session.user;

    if (user){
      isAuthed = true;
      try {
        cloud = await cloudAdapter.load();
        cloudLoadOk = true;
      } catch(e){
        console.warn('cloud load failed', e);
        cloudLoadOk = false;
        cloud = null;
      }
    }
  }

  var cloudNorm = cloud ? normalizeData(cloud) : null;

  if (!localNorm && !cloudNorm){
    return { bothEmpty: true, isAuthed: isAuthed, cloudLoadOk: cloudLoadOk };
  }

  var lt = computeDataTimeByTasks(localNorm);
  var ct = computeDataTimeByTasks(cloudNorm);

  var base = (cloudNorm && (!localNorm || ct >= lt)) ? cloudNorm : localNorm;

  // tasks idごとマージ（現状の実装を活かす）
  var map = new Map();
  (localNorm ? localNorm.tasks : []).forEach(function(t){
    if (t && t.id) map.set(t.id, { local: t, cloud: null });
  });
  (cloudNorm ? cloudNorm.tasks : []).forEach(function(t){
    if (!t || !t.id) return;
    var cur = map.get(t.id) || { local: null, cloud: null };
    cur.cloud = t;
    map.set(t.id, cur);
  });

  var mergedTasks = [];
  map.forEach(function(pair){
    var merged = mergeTask(pair.local, pair.cloud);
    if (merged) mergedTasks.push(merged);
  });

  state.data = normalizeData({
    projects: base.projects,
    sections: base.sections,
    ui: base.ui,
    tasks: mergedTasks
  });
  state.data.meta.updatedAt = new Date().toISOString();

  // ローカルへミラー
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state.data));

  // ✅ クラウドへは「ログイン中 & クラウドロード成功」のときだけミラー
  if (isAuthed && cloudLoadOk){
    try { await cloudAdapter.save(state.data); } catch(e){}
  }

  return { bothEmpty: false, isAuthed: isAuthed, cloudLoadOk: cloudLoadOk };
}

// 実保存（Local-first：ローカルが常に正、ログイン時だけクラウドへミラー）
async function persistNow(meta){
  meta = meta || {};
  var now = Date.now();

  // ログイン直後クールダウン中は保存しない
  // ただし beforeunload のときは再予約しない（無限リトライ防止）
  if (now < _cooldownUntil){
    if (!meta.fromUnload) {
      schedulePersist('cooldown_retry');
    }
    return;
  }

  // サンプル/空データは保存停止（事故防止）
  if (isSampleOrEmpty()){
    // 明示的に「空保存OK」の操作だけ許可
    if (!meta.allowEmpty) return;
  }

  // 同時実行抑止
  if (_persistInFlight){
    _dirtyWhileInFlight = true;
    return;
  }

  _persistInFlight = true;
  _dirtyWhileInFlight = false;

  state.data.meta.updatedAt = new Date().toISOString();

  try {
    // ✅ 上書き前に世代バックアップ（ローカルのメインを退避）
    backupBeforeOverwrite();

    // ✅ 1) ローカルは常に保存（Local-first）
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state.data));

    // ✅ 2) ログイン中：クラウド上書き防止（compare before save）
    if (supabaseClient){
      var s = await supabaseClient.auth.getSession();
      var user = s && s.data && s.data.session && s.data.session.user;
      if (user) {
        // クラウドの現状を読む
        var cloudData = null;
        try {
          cloudData = await cloudAdapter.load();
        } catch(e){
          console.warn('cloud load failed (persistNow)', e);
          cloudData = null;
        }
    
        // 「タスク更新時刻」ベースで比較（meta.updatedAtは信用しない）
        var localTime = computeDataTimeByTasks(state.data);
        var cloudTime = computeDataTimeByTasks(cloudData);
    
        if (localTime >= cloudTime) {
          await cloudAdapter.save(state.data);
        } else {
          // クラウドの方が新しい → ローカルをクラウドへ寄せる（上書き事故防止）
          state.data = normalizeData(cloudData);
    
          // ローカルは必ず最新化（Local-firstの土台）
          backupBeforeOverwrite();
          localStorage.setItem(STORAGE_KEY, JSON.stringify(state.data));
    
          toast('クラウドの最新データを採用しました');
        }
      }
    }
  }
  catch (e) {
    console.error(e);
    toast('保存に失敗（ログイン状態を確認）');
  }
  finally {
    _persistInFlight = false;
    if (_dirtyWhileInFlight){
      schedulePersist('dirty_while_in_flight');
    }
  }
}

// 復元（最低限）
function restoreFromBackupKey(backupKey){
  var json = localStorage.getItem(backupKey);
  if (!json) throw new Error('Backup not found: ' + backupKey);

  // メインへ戻す（=次回ロードも復旧）
  localStorage.setItem(STORAGE_KEY, json);

  var obj = null;
  try { obj = JSON.parse(json); } catch { obj = null; }
  if (!obj) throw new Error('Backup JSON parse failed');

  state.data = normalizeData(obj);
  hydrateSelectors();
  renderProjects();
  setDateRange(state.data.ui.dateRange || 'today', true);
  renderAll();
  toast('バックアップから復元しました');
}

function openLocalBackups(){
  var keys = listBackupKeys();
  if (!keys.length){ toast('バックアップがありません'); return; }

  var chosen = prompt('復元するバックアップキーを選んで貼り付けてください:\n\n' + keys.join('\n'), keys[0]);
  if (!chosen) return;

  if (!confirm('このバックアップから復元します。\n現在の状態は上書きされます。\n\n' + chosen)) return;

  try {
    window.TaskchuteBackup.restoreFromBackupKey(chosen);
  } catch (e){
    console.error(e);
    toast('復元に失敗しました');
  }
}
window.openLocalBackups = openLocalBackups;

// デバッグ公開（任意）
window.TaskchuteBackup = {
  listBackupKeys: listBackupKeys,
  restoreFromBackupKey: restoreFromBackupKey,
  schedulePersist: schedulePersist,
  persistNow: persistNow,
  startLoginCooldown: startLoginCooldown
};

async function persist(meta){
  meta = meta || {};
  if (__TEST_MODE__) return;
  // 通常はデバウンス
  if (!meta.force) {
    schedulePersist('persist()');
    return;
  }
  // 重要操作は即保存して await できるように
  await persistNow({ reason: meta.reason || 'persist(force)', allowEmpty: !!meta.allowEmpty });
}

  /*********************
   * 5) UI base
   *********************/
  function openModal(id){ document.getElementById(id).classList.remove('hidden'); }
  function closeModal(id){
    document.getElementById(id).classList.add('hidden');
    if (id === 'search-modal') document.getElementById('search-q').value = '';
  }

  function toggleSidebar(){
    var sidebar = document.getElementById('sidebar');
    var overlay = document.getElementById('sidebar-overlay');
    var opened = !sidebar.classList.contains('sidebar-hidden');
    if (opened){
      sidebar.classList.add('sidebar-hidden');
      overlay.classList.add('hidden');
      document.body.classList.remove('sidebar-open');
    } else {
      sidebar.classList.remove('sidebar-hidden');
      overlay.classList.remove('hidden');
      document.body.classList.add('sidebar-open');
    }
  }

  function switchSidebarTab(tab){
    var tabPlan = document.getElementById('tab-plan');
    var tabSync = document.getElementById('tab-sync');
    var viewPlan = document.getElementById('view-plan');
    var viewSync = document.getElementById('view-sync');

    if (tab === 'plan'){
      tabPlan.classList.add('tab-active');
      tabSync.classList.remove('tab-active');
      viewPlan.classList.remove('hidden');
      viewSync.classList.add('hidden');
    } else {
      tabSync.classList.add('tab-active');
      tabPlan.classList.remove('tab-active');
      viewSync.classList.remove('hidden');
      viewPlan.classList.add('hidden');
    }
  }

  function openQuickSearch(){
    openModal('search-modal');
    setTimeout(function(){ document.getElementById('search-q').focus(); }, 50);
  }

  document.addEventListener('keydown', function(e){
    if (e.key === 'Escape'){
      ['task-modal','project-modal','search-modal','auth-modal'].forEach(function(id){
        var el = document.getElementById(id);
        if (el && !el.classList.contains('hidden')) closeModal(id);
      });
    }
  });

  /*********************
   * 6) Selectors
   *********************/
  function hydrateSelectors(){
    var sectionSel = document.getElementById('task-section');
    if (sectionSel){
      sectionSel.innerHTML = '';
      state.data.sections.forEach(function(s){
        var opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = s.name;
        sectionSel.appendChild(opt);
      });
    }

    var projSel = document.getElementById('task-project');
    if (projSel){
      projSel.innerHTML = '';
      state.data.projects.forEach(function(p){
        var opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = p.name;
        projSel.appendChild(opt);
      });
    }
  }

  function getProject(id){ return state.data.projects.find(function(p){ return p.id===id; }); }
  function getSection(id){ return state.data.sections.find(function(s){ return s.id===id; }); }

  function isPrivateProjectId(projectId){
    var p = getProject(projectId);
    if (!p) return false;
    return String(p.name || '').trim() === 'プライベート';
  }
  
  /*********************
   * 7) Auth
   *********************/
  function openAuthModal(){
    if (!supabaseClient){
      toast('Supabase設定が未入力です');
      return;
    }
    openModal('auth-modal');
  }

  async function refreshAuthChip(){
    var chip = document.getElementById('auth-chip');
    var label = document.getElementById('auth-label');
    if (!chip || !label) return;

    chip.classList.remove('hidden');

    if (!supabaseClient){
      label.textContent = '未設定';
      return;
    }

    var s = await supabaseClient.auth.getSession();
    var user = s && s.data && s.data.session && s.data.session.user;
    if (user){
      label.textContent = user.email || 'ログイン中';
      setStorageModeUI('Supabase');
    } else {
      label.textContent = '未ログイン';
      setStorageModeUI('LocalStorage');
    }
  }

  async function authSignIn(){
    if (!supabaseClient) return;
    var email = document.getElementById('auth-email').value.trim();
    var pass = document.getElementById('auth-pass').value;
    if (!email || !pass){ toast('Email/Passwordを入力してください'); return; }

    var res = await supabaseClient.auth.signInWithPassword({ email: email, password: pass });
    if (res.error){ toast('ログイン失敗: ' + res.error.message); return; }

    toast('ログインしました');
    startLoginCooldown();
    await refreshAuthChip();
    await loadFromCloudThenRender();
    closeModal('auth-modal');
  }

  async function authSignUp(){
    if (!supabaseClient) return;
    var email = document.getElementById('auth-email').value.trim();
    var pass = document.getElementById('auth-pass').value;
    if (!email || !pass){ toast('Email/Passwordを入力してください'); return; }

    var res = await supabaseClient.auth.signUp({ email: email, password: pass });
    if (res.error){ toast('登録失敗: ' + res.error.message); return; }

    toast('登録しました');
    startLoginCooldown();
    await refreshAuthChip();
    await loadFromCloudThenRender();
    closeModal('auth-modal');
  }

  async function authSignOut(){
    if (!supabaseClient) return;
    await supabaseClient.auth.signOut();
    toast('ログアウトしました');
    await refreshAuthChip();

    var local = await localAdapter.load();
    if (local) state.data = normalizeData(local);
    
    renderProjects();
    setDateRange(state.data.ui.dateRange || 'today', true);
    renderAll();
     }

  async function migrateLocalToCloud(){
    if (!supabaseClient) return;
    var s = await supabaseClient.auth.getSession();
    var user = s && s.data && s.data.session && s.data.session.user;
    if (!user){ toast('先にログインしてください'); return; }

    var local = await localAdapter.load();
    if (!local){ toast('移行するローカルデータがありません'); return; }

    state.data = normalizeData(local);
    await persistNow({ reason: 'migrateLocalToCloud', allowEmpty: true });
    toast('ローカル → クラウドへ移行しました');
    closeModal('auth-modal');
    renderProjects();
    renderAll();
  }

async function loadFromCloudThenRender(){
  try {
    var rc = await reconcileLocalAndCloud();

    // ✅ “初回（ローカルもクラウドも本当に空）” のときだけサンプル生成
    // - ログイン中なら「クラウド問い合わせが成功した上で空」を要求（通信失敗の誤判定を避ける）
    var shouldInitSample =
      rc && rc.bothEmpty === true &&
      (
        (rc.isAuthed === false) || (rc.isAuthed === true && rc.cloudLoadOk === true)
      );

    if (shouldInitSample) {
      var today = nowISODate();
      state.data = normalizeData({
        projects: [ { id: 'inbox', name: 'INBOX' } ],
        sections: DEFAULT_SECTIONS,
        tasks: [{
          id: uid(),
          name: '（例）今日の計画を立てる',
          sectionId: 'morning',
          projectId: 'inbox',
          estimateMin: 15,
          actualMin: 0,
          date: today,
          repeat: 'none',
          status: 'pending',
          priority: 3,
          isInterrupt: false,
          notes: '備考が必須です。ここに判断メモや条件を書きます。',
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString(),
          startedAt: null,
        }],
        ui: { dateRange:'today', projectFilter:null }
      });

      // ★サンプルは「ローカルだけ」に確実に置く（クラウドへは無理に同期しない）
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state.data));
      // cloudへは送らない（初回のつもりが通信不安定だと事故るため）
    }
    
    renderProjects();
    setDateRange(state.data.ui.dateRange || 'today', true);
    renderAll();
  } catch (e) {
    console.error(e);
    toast('読み込みに失敗しました');
  }
}

  /*********************
   * 8) Filters
   *********************/
  function setDateRange(range, skipPersist){
    state.data.ui.dateRange = range;

    ['today','rolling7','week','month','undated'].forEach(function(k){
      var btn = document.getElementById('btn-'+k);
      var btnm = document.getElementById('btn-'+k+'-m');
      if (btn){ btn.classList.toggle('active', k===range); btn.classList.toggle('text-slate-500', k!==range); }
      if (btnm){ btnm.classList.toggle('active', k===range); btnm.classList.toggle('text-slate-500', k!==range); }
    });

    if (!skipPersist) persist();
    renderAll();
  }

  function setProjectFilter(projectId){
    state.data.ui.projectFilter = projectId;
    persist();
    renderProjects();
    renderAll();
  }

  function inWeek(dateStr){
    if (!dateStr) return false;
    var d = new Date(dateStr + 'T00:00:00');
    var now = new Date();
    var day = now.getDay();
    var diffToMon = (day === 0 ? -6 : 1 - day);
    var monday = new Date(now); monday.setHours(0,0,0,0); monday.setDate(now.getDate() + diffToMon);
    var sunday = new Date(monday); sunday.setDate(monday.getDate() + 6); sunday.setHours(23,59,59,999);
    return d >= monday && d <= sunday;
  }
  
  // 今日〜7日先まで（rolling 7 days）
  function inRolling7(dateStr){
    if (!dateStr) return false;
    var d = new Date(dateStr + 'T00:00:00');
    var start = new Date();
    start.setHours(0,0,0,0);
    var end = new Date(start);
    end.setDate(start.getDate() + 7);
    end.setHours(23,59,59,999);
    return d >= start && d <= end;
  }
  
 // 今月（暦月）
 function inMonth(dateStr){
   if (!dateStr) return false;
   var d = new Date(dateStr + 'T00:00:00');
   var now = new Date();
   return d.getFullYear() === now.getFullYear() &&
          d.getMonth() === now.getMonth();
 }

  function matchesDateRange(task){
    var r = state.data.ui.dateRange;
    if (r === 'undated') return !task.date;
    if (r === 'today') return task.date === nowISODate();
    if (r === 'rolling7') return inRolling7(task.date);
    if (r === 'week') return inWeek(task.date);
    if (r === 'month') return inMonth(task.date);
    return true;
  }

  function isVisibleByFilters(task){
    var showCompleted = document.getElementById('filter-completed').checked;
    var uncompletedOnly = document.getElementById('filter-uncompleted-only').checked;

    if (!showCompleted && task.status === 'completed') return false;
    if (uncompletedOnly && task.status === 'completed') return false;

    var pf = state.data.ui.projectFilter;
    if (pf && task.projectId !== pf) return false;

    var qEl = document.getElementById('search-q');
    var q = (qEl ? qEl.value : '').trim().toLowerCase();
    if (q){
      var pj = (getProject(task.projectId) && getProject(task.projectId).name) ? getProject(task.projectId).name : '';
      var s = (task.name + ' ' + task.notes + ' ' + pj).toLowerCase();
      if (!s.includes(q)) return false;
    }

    return matchesDateRange(task);
  }

  /*********************
   * 9) Running controls
   *********************/
  function finalizeRunningIfNeeded(t){
    if (!t) return 0;
    if (t.status === 'running' && t.startedAt){
      var add = elapsedMinSince(t.startedAt);
      if (add > 0) t.actualMin = Math.max(0, Number(t.actualMin||0) + add);
      t.startedAt = null;
      return add;
    }
    return 0;
  }

  function setTaskStatus(t, nextStatus){
    if (!t) return;
    // running からの遷移は必ず精算してから
    if (t.status === 'running' && nextStatus !== 'running'){
    finalizeRunningIfNeeded(t);
    }
    t.status = nextStatus;
    if (nextStatus === 'running' && !t.startedAt){
      t.startedAt = new Date().toISOString();
    }
    if (nextStatus !== 'running'){
      t.startedAt = null;
    }
    t.updatedAt = new Date().toISOString();
  }
  
function stopTask(taskId, opts){
  opts = opts || {};
  var t = state.data.tasks.find(function(x){ return x.id===taskId; });
  if (!t) return;

  // 停止/中断は “経過を actualMin に加算 → startedAt=null → paused”
  finalizeRunningIfNeeded(t);

  if (opts.setPaused === true) setTaskStatus(t, 'paused');
  else if (opts.setPaused === false) setTaskStatus(t, 'pending');
  else setTaskStatus(t, 'paused');
}

  async function startTask(taskId){
    var t = state.data.tasks.find(function(x){ return x.id===taskId; });
    if (!t) return;

    var running = state.data.tasks.find(function(x){ return x.status==='running' && x.id!==taskId; });
    // ✅ 他の running がいたら “中断（paused）” に寄せる（実績精算も確実）
    if (running) stopTask(running.id, { setPaused: true });
    setTaskStatus(t, 'running');
    
    await persist();
    renderAll();
  }

  async function pauseTask(taskId){
    stopTask(taskId, { setPaused: true });
    await persist();
    renderAll();
  }

  async function postponeTask(taskId, days){
    days = days || 1;
    var t = state.data.tasks.find(function(x){ return x.id===taskId; });
    if (!t) return;
    
    if (t.status === 'running') stopTask(t.id, { setPaused: true });

    var base = t.date ? t.date : nowISODate();
    t.date = addDaysISO(base, days);
    t.updatedAt = new Date().toISOString();

    await persist();
    toast('先送りしました（+1日）');
    renderAll();
  }

function enforceEveningRule(now){
  now = now || new Date();

  // 18:40以降のみ発動
  if (!isAfterEveningCutoff(now)) return;

  var runningTask = state.data.tasks.find(function(t){ return t.status === 'running'; });
  if (!runningTask) return;
  
  //プライベートは自動化しない
  if(isPrivateProjectId(runningTask.projectId))return;
  
  if (!DAYTIME_SECTIONS.has(runningTask.sectionId)) return;

  stopTask(runningTask.id, { setPaused: true });

  var base = runningTask.date ? runningTask.date : nowISODate();
  runningTask.date = addDaysISO(base, 1);
  runningTask.updatedAt = new Date().toISOString();

  persist();
  toast('18:40以降のため、中断→翌日に先送りしました');
  }

  async function loopTask(taskId){
  var t = state.data.tasks.find(function(x){ return x.id===taskId; });
  if (!t) return;

  // running中なら精算して止める
  if (t.status === 'running') {
    stopTask(t.id, { setPaused: true });
  }

  // 元タスクは完了状態にする（すでに完了ならそのまま）
  if (t.status !== 'completed') {
    setTaskStatus(t, 'completed');
  } else {
    t.updatedAt = new Date().toISOString();
  }

  // 翌日へ複製
  var baseDate = t.date ? t.date : nowISODate();
  var nextDate = addDaysISO(baseDate, 1);

  var newTask = JSON.parse(JSON.stringify(t));
  newTask.id = uid();
  newTask.date = nextDate;
  newTask.sectionId = t.sectionId || 'afternoon'; // ★同じ時間枠
  newTask.actualMin = 0;
  newTask.status = 'pending';                     // ★未実行
  newTask.startedAt = null;                       // ★開始しない
  newTask.createdAt = new Date().toISOString();
  newTask.updatedAt = new Date().toISOString();

  state.data.tasks.push(newTask);

  await persist();
  toast('ループ: 翌日に未実行タスクを複製しました');
  renderAll();
}

/*********************
   * 10) Render
   *********************/
  function statusClass(task){
    if (task.status === 'completed') return 'status-completed';
    if (task.status === 'running') return 'status-running';
    if (task.status === 'paused') return 'status-paused';
    if (task.date && task.date > nowISODate()) return 'status-future';
    return 'status-pending';
  }

  function priorityBadge(p){
    var map = {
      1:['高','bg-rose-100 text-rose-700'],
      2:['やや高','bg-amber-100 text-amber-700'],
      3:['通常','bg-slate-100 text-slate-700'],
      4:['低','bg-slate-100 text-slate-500']
    };
    var tup = map[p] || map[3];
    return '<span class="text-[10px] font-bold px-2 py-0.5 rounded-full ' + tup[1] + '">' + tup[0] + '</span>';
  }
function buildTaskCard(t){
  var pj = (getProject(t.projectId) && getProject(t.projectId).name) ? getProject(t.projectId).name : '—';
  var elapsed = (t.status==='running') ? elapsedMinSince(t.startedAt) : 0;

  var card = document.createElement('div');
  card.className = 'task-card bg-white border border-slate-100 rounded-3xl p-5 transition cursor-pointer ' + statusClass(t);
  card.onclick = function(){ openTaskModal(t.id); };

  card.innerHTML =
    '<div class="flex items-start justify-between gap-3">' +
      '<div class="min-w-0">' +
        '<div class="flex items-center gap-2 flex-wrap">' +
          '<p class="font-bold text-slate-800 truncate">' + escapeHtml(t.name || '(無題)') + '</p>' +
          (t.isInterrupt ? '<span class="text-[10px] font-black px-2 py-0.5 rounded-full bg-rose-100 text-rose-700">割り込み</span>' : '') +
          priorityBadge(t.priority) +
          (t.status==='running'
            ? '<span data-elapsed-task-id="' + t.id + '" class="text-[10px] font-black px-2 py-0.5 rounded-full bg-blue-100 text-blue-700">経過 ' + elapsed + 'm</span>'
            : '') +
        '</div>' +
        '<div class="mt-1 text-xs text-slate-500 flex flex-wrap gap-x-3 gap-y-1">' +
          '<span><i class="fa-regular fa-folder-open"></i> ' + escapeHtml(pj) + '</span>' +
          '<span><i class="fa-regular fa-hourglass"></i> 見積 ' + fmtMin(t.estimateMin) + '</span>' +
          '<span><i class="fa-regular fa-circle-check"></i> 実績 ' + fmtMin(t.actualMin) + '</span>' +
        '</div>' +
      '</div>' +

      '<div class="task-actions flex items-center gap-2">' +
        (t.status === 'running'
          ? '<button onclick="event.stopPropagation(); pauseTask(\'' + t.id + '\')" class="p-2 rounded-xl border hover:bg-slate-50" title="中断（停止）" aria-label="pause"><i class="fas fa-pause text-amber-600"></i></button>'
          : '<button onclick="event.stopPropagation(); startTask(\'' + t.id + '\')" class="p-2 rounded-xl border hover:bg-slate-50" title="開始（再生）" aria-label="start"><i class="fas fa-play text-blue-600"></i></button>'
        ) +
        (t.status === 'completed'
          ? '<button onclick="event.stopPropagation(); loopTask(\'' + t.id + '\')" class="p-2 rounded-xl border hover:bg-slate-50" title="ループ（翌日に複製）" aria-label="loop">' +
              '<i class="fas fa-rotate-right text-slate-600"></i>' +
            '</button>'
          : ''
        ) +
        '<button onclick="event.stopPropagation(); toggleComplete(\'' + t.id + '\')" class="p-2 rounded-xl border hover:bg-slate-50" title="完了" aria-label="toggle complete">' +
          '<i class="fas ' + (t.status==='completed' ? 'fa-rotate-left text-slate-500' : 'fa-check text-emerald-600') + '"></i>' +
        '</button>' +
      '</div>' +
    '</div>' +

    '<div class="mt-4 bg-slate-50 border border-slate-100 rounded-2xl p-3">' +
      '<p class="text-xs text-slate-700 whitespace-pre-wrap">' + escapeHtml(t.notes || '') + '</p>' +
    '</div>';

  return card;
}
  
  function recomputeTotals(){
    var visible = state.data.tasks.filter(isVisibleByFilters);
    var est = visible.reduce(function(a,t){ return a + (Number(t.estimateMin)||0); }, 0);
    // ✅ 実績合計：表示中 actualMin の合計 + running の経過分（リアルタイム見え）
    var act = visible.reduce(function(a,t){
    var base = Number(t.actualMin)||0;
    var extra = (t.status==='running' && t.startedAt) ? elapsedMinSince(t.startedAt) : 0;
    return a + base + extra;
    }, 0);
    document.getElementById('total-estimate').textContent = fmtMin(est);
    document.getElementById('total-actual').textContent = fmtMin(act);

    var undatedCount = state.data.tasks.filter(function(t){ return !t.date && t.status!=='completed'; }).length;
    document.getElementById('undated-count').textContent = String(undatedCount);

    var interruptCount = visible.filter(function(t){ return !!t.isInterrupt; }).length;
    document.getElementById('interrupt-count').textContent = String(interruptCount);

    var now = new Date();
    var finish = new Date(now.getTime() + est*60000);
    var hh = String(finish.getHours()).padStart(2,'0');
    var mm = String(finish.getMinutes()).padStart(2,'0');
    document.getElementById('finish-estimate').textContent = hh + ':' + mm;
  }

  function renderProjects(){
    var list = document.getElementById('project-list');
    var pf = state.data.ui.projectFilter;
    list.innerHTML = '';

    state.data.projects.slice().sort(function(a,b){ return a.name.localeCompare(b.name,'ja'); }).forEach(function(p){
      var count = state.data.tasks.filter(function(t){ return t.projectId===p.id && t.status!=='completed'; }).length;
      var active = pf === p.id;
      var btn = document.createElement('button');
      btn.className = 'w-full flex justify-between items-center px-3 py-2 rounded-xl text-xs font-bold border transition ' +
        (active ? 'bg-blue-50 border-blue-200 text-blue-700' : 'bg-white border-slate-100 text-slate-700 hover:bg-slate-50');
      btn.innerHTML = '<span class="truncate">' + escapeHtml(p.name) + '</span><span class="text-[10px] ' + (active ? 'text-blue-700' : 'text-slate-400') + '">' + count + '</span>';
      btn.onclick = function(){ setProjectFilter(p.id); };
      list.appendChild(btn);
    });

    hydrateSelectors();
  }

  function renderAll(){
    
    var container = document.getElementById('task-container');

    var tasks = state.data.tasks.slice().sort(function(a,b){
      if (state.data.ui.dateRange === 'undated') return (a.createdAt||'').localeCompare(b.createdAt||'');
      var ad = a.date || '9999-12-31';
      var bd = b.date || '9999-12-31';
      if (ad !== bd) return ad.localeCompare(bd);
      var sIdx = function(id){ return state.data.sections.findIndex(function(s){ return s.id===id; }); };
      var ai = sIdx(a.sectionId); var bi = sIdx(b.sectionId);
      if (ai !== bi) return ai - bi;
      return (Number(a.priority)||3) - (Number(b.priority)||3);
    }).filter(isVisibleByFilters);

    if (!tasks.length){
      container.innerHTML = '<div class="bg-white border rounded-3xl p-8 text-center">' +
        '<div class="text-3xl mb-2">🗂️</div>' +
        '<p class="font-bold text-slate-800">表示するタスクがありません</p>' +
        '<p class="text-sm text-slate-500 mt-1">右下の＋から追加できます</p>' +
        '</div>';
      recomputeTotals();
      return;
    }

    // date -> tasks
    var dateGroups = new Map();
    tasks.forEach(function(t){
      var dk = t.date || '未設定';
      if (!dateGroups.has(dk)) dateGroups.set(dk, []);
      dateGroups.get(dk).push(t);
    });

    container.innerHTML = '';

    dateGroups.forEach(function(dateItems, dateKey){
      var dateSection = document.createElement('section');
      dateSection.className = 'mb-10';

      var dateHeader = document.createElement('div');
      dateHeader.className = 'flex items-center justify-between mb-3';
      var label = (dateKey==='未設定') ? '未設定' : prettyDate(dateKey);
      dateHeader.innerHTML = '<h2 class="text-[11px] font-black text-slate-400 uppercase tracking-widest">' + escapeHtml(label) + '</h2>' +
        '<div class="text-[11px] text-slate-400">' + dateItems.length + '件</div>';

      // section -> tasks
      var bySection = new Map();
      dateItems.forEach(function(t){
        var sid = t.sectionId || 'unknown';
        if (!bySection.has(sid)) bySection.set(sid, []);
        bySection.get(sid).push(t);
      });

      var list = document.createElement('div');
      list.className = 'space-y-6';

      var list = document.createElement('div');
list.className = 'space-y-6';

var isMonthView = (state.data.ui.dateRange === 'month');

if (isMonthView) {
  // monthビュー：日付ごとに「カードだけ」並べる（セクション見出しは出さない）
  var cards = document.createElement('div');
  cards.className = 'space-y-3';

  dateItems.forEach(function(t){
    cards.appendChild(buildTaskCard(t));
  });

  list.appendChild(cards);

} else {
  // 既存：セクション見出し＋カード
  var sectionOrder = state.data.sections.map(function(s){ return s.id; });
  sectionOrder.forEach(function(sid){
    var sectionItems = bySection.get(sid) || [];
    var seName = (sid==='unknown') ? '（未分類）' : ((getSection(sid) && getSection(sid).name) ? getSection(sid).name : '（未分類）');
    var secEst = sectionItems.reduce(function(a,t){ return a + (Number(t.estimateMin)||0); }, 0);
    var secAct = sectionItems.reduce(function(a,t){
      var base = Number(t.actualMin)||0;
      var extra = (t.status==='running' && t.startedAt) ? elapsedMinSince(t.startedAt) : 0;
      return a + base + extra;
    }, 0);
    var secInterrupt = sectionItems.filter(function(t){ return !!t.isInterrupt; }).length;

    var header = document.createElement('div');
    header.className = 'flex items-center justify-between px-1';
    header.innerHTML = '<div class="flex items-center gap-2">' +
      '<span class="text-xs font-black text-slate-700">' + escapeHtml(seName) + '</span>' +
      '<span class="text-[10px] font-bold px-2 py-0.5 rounded-full bg-slate-100 text-slate-600">' + sectionItems.length + '件</span>' +
      (secInterrupt ? '<span class="text-[10px] font-black px-2 py-0.5 rounded-full bg-rose-100 text-rose-700">割り込み ' + secInterrupt + '</span>' : '') +
      '</div>' +
      '<div class="text-[11px] text-slate-500">見積 ' + fmtMin(secEst) + ' / 実績 ' + fmtMin(secAct) + '</div>';

    var cards = document.createElement('div');
    cards.className = 'space-y-3';

    // 空枠プレースホルダは通常ビューのみ
    if (!sectionItems.length){
      var empty = document.createElement('div');
      empty.className = 'bg-white/60 border border-dashed border-slate-200 rounded-2xl p-4 text-xs text-slate-400';
      empty.textContent = 'タスクなし';
      cards.appendChild(empty);
    }

    sectionItems.forEach(function(t){
      cards.appendChild(buildTaskCard(t));
    });

    var block = document.createElement('div');
    block.className = 'space-y-3';
    block.appendChild(header);
    block.appendChild(cards);
    list.appendChild(block);
  });
}
      
      // ✅ “タスクがなくても時間枠を表示” のため、sections順で必ず回す
      var sectionOrder = state.data.sections.map(function(s){ return s.id; });
      sectionOrder.forEach(function(sid){
        var sectionItems = bySection.get(sid) || [];
        var seName = (sid==='unknown') ? '（未分類）' : ((getSection(sid) && getSection(sid).name) ? getSection(sid).name : '（未分類）');
        var secEst = sectionItems.reduce(function(a,t){ return a + (Number(t.estimateMin)||0); }, 0);
        var secAct = sectionItems.reduce(function(a,t){
        var base = Number(t.actualMin)||0;
        var extra = (t.status==='running' && t.startedAt) ? elapsedMinSince(t.startedAt) : 0;
        return a + base + extra;
        }, 0);
        var secInterrupt = sectionItems.filter(function(t){ return !!t.isInterrupt; }).length;

        
        var header = document.createElement('div');
        header.className = 'flex items-center justify-between px-1';
        header.innerHTML = '<div class="flex items-center gap-2">' +
          '<span class="text-xs font-black text-slate-700">' + escapeHtml(seName) + '</span>' +
          '<span class="text-[10px] font-bold px-2 py-0.5 rounded-full bg-slate-100 text-slate-600">' + sectionItems.length + '件</span>' +
          (secInterrupt ? '<span class="text-[10px] font-black px-2 py-0.5 rounded-full bg-rose-100 text-rose-700">割り込み ' + secInterrupt + '</span>' : '') +
          '</div>' +
          '<div class="text-[11px] text-slate-500">見積 ' + fmtMin(secEst) + ' / 実績 ' + fmtMin(secAct) + '</div>';

        var cards = document.createElement('div');
        cards.className = 'space-y-3';
  // ✅ 空枠でも表示（軽いプレースホルダ）
        if (!sectionItems.length){
          var empty = document.createElement('div');
          empty.className = 'bg-white/60 border border-dashed border-slate-200 rounded-2xl p-4 text-xs text-slate-400';
          empty.textContent = 'タスクなし';
          cards.appendChild(empty);
        }
        sectionItems.forEach(function(t){
          var pj = (getProject(t.projectId) && getProject(t.projectId).name) ? getProject(t.projectId).name : '—';
          var elapsed = (t.status==='running') ? elapsedMinSince(t.startedAt) : 0;

          var card = document.createElement('div');
          card.className = 'task-card bg-white border border-slate-100 rounded-3xl p-5 transition cursor-pointer ' + statusClass(t);
          // ✅ ペン廃止：カード本体クリックで詳細モーダル
          card.onclick = function(){ openTaskModal(t.id); };
          card.innerHTML = '<div class="flex items-start justify-between gap-3">' +
            '<div class="min-w-0">' +
              '<div class="flex items-center gap-2 flex-wrap">' +
                '<p class="font-bold text-slate-800 truncate">' + escapeHtml(t.name || '(無題)') + '</p>' +
                (t.isInterrupt ? '<span class="text-[10px] font-black px-2 py-0.5 rounded-full bg-rose-100 text-rose-700">割り込み</span>' : '') +
                priorityBadge(t.priority) +
                 (t.status==='running'
                  ? '<span data-elapsed-task-id="' + t.id + '" class="text-[10px] font-black px-2 py-0.5 rounded-full bg-blue-100 text-blue-700">経過 ' + elapsed + 'm</span>'
                   : '') +
              '</div>' +
              '<div class="mt-1 text-xs text-slate-500 flex flex-wrap gap-x-3 gap-y-1">' +
                '<span><i class="fa-regular fa-folder-open"></i> ' + escapeHtml(pj) + '</span>' +
                '<span><i class="fa-regular fa-hourglass"></i> 見積 ' + fmtMin(t.estimateMin) + '</span>' +
                '<span><i class="fa-regular fa-circle-check"></i> 実績 ' + fmtMin(t.actualMin) + '</span>' +
              '</div>' +
            '</div>' +

            '<div class="task-actions flex items-center gap-2">' +
              (t.status === 'running'
                ? '<button onclick="event.stopPropagation(); pauseTask(\'' + t.id + '\')" class="p-2 rounded-xl border hover:bg-slate-50" title="中断（停止）" aria-label="pause"><i class="fas fa-pause text-amber-600"></i></button>'
                : '<button onclick="event.stopPropagation(); startTask(\'' + t.id + '\')" class="p-2 rounded-xl border hover:bg-slate-50" title="開始（再生）" aria-label="start"><i class="fas fa-play text-blue-600"></i></button>'
              ) +
              (t.status === 'completed'
               ? '<button onclick="event.stopPropagation(); loopTask(\'' + t.id + '\')" class="p-2 rounded-xl border hover:bg-slate-50" title="ループ（翌日に複製）" aria-label="loop">' +
               '<i class="fas fa-rotate-right text-slate-600"></i>'+
               '</button>'
               : ''
              ) +

              // ✅ 一覧は最小構成：再生/停止 + 完了
               '<button onclick="event.stopPropagation(); toggleComplete(\'' + t.id + '\')" class="p-2 rounded-xl border hover:bg-slate-50" title="完了" aria-label="toggle complete">' +
               '<i class="fas ' + (t.status==='completed' ? 'fa-rotate-left text-slate-500' : 'fa-check text-emerald-600') + '"></i>' +
             '</button>' +
            '</div>' +
          '</div>' +

          '<div class="mt-4 bg-slate-50 border border-slate-100 rounded-2xl p-3">' +
            '<p class="text-xs text-slate-700 whitespace-pre-wrap">' + escapeHtml(t.notes || '') + '</p>' +
          '</div>';

          cards.appendChild(card);
        });

        var block = document.createElement('div');
        block.className = 'space-y-3';
        block.appendChild(header);
        block.appendChild(cards);
        list.appendChild(block);
      });

      dateSection.appendChild(dateHeader);
      dateSection.appendChild(list);
      container.appendChild(dateSection);
    });
    recomputeTotals();
  }
 
  function tickRunningUI(){
  // running の経過表示だけ更新
  state.data.tasks.forEach(function(t){
    if (t.status !== 'running' || !t.startedAt) return;
    var el = document.querySelector('[data-elapsed-task-id="'+ t.id +'"]');
    if (!el) return;
    el.textContent = '経過 ' + elapsedMinSince(t.startedAt) + 'm';
  });

    // ヘッダーの実績合計も更新（renderAllなしで）
    recomputeTotals();
  }
  
  /*********************
   * 11) CRUD
   *********************/
  function openTaskModal(taskId, isInterrupt){
    taskId = taskId || null;
    isInterrupt = !!isInterrupt;

    var t = taskId ? state.data.tasks.find(function(x){ return x.id===taskId; }) : null;

    document.getElementById('modal-title').textContent = taskId ? 'タスク編集' : 'タスク追加';
    document.getElementById('task-id').value = (t && t.id) ? t.id : '';
    document.getElementById('task-is-interrupt').value = ((t && t.isInterrupt) || isInterrupt) ? '1' : '';

    var defaultSection = 'afternoon';
    var defaultDate = nowISODate();

    document.getElementById('task-name').value = (t && t.name) ? t.name : '';
    document.getElementById('task-section').value = (t && t.sectionId) ? t.sectionId : defaultSection;
    document.getElementById('task-project').value = (t && t.projectId) ? t.projectId : 'inbox';

    document.getElementById('task-duration').value = (t && t.estimateMin != null) ? t.estimateMin : 0;
    document.getElementById('task-deadline').value = t ? (t.date || '') : defaultDate;
    document.getElementById('task-repeat').value = (t && t.repeat) ? t.repeat : 'none';
    document.getElementById('task-status').value = (t && t.status) ? t.status : 'pending';
    document.getElementById('task-actual').value = (t && t.actualMin != null) ? t.actualMin : 0;
    document.getElementById('task-priority').value = String((t && t.priority != null) ? t.priority : 3);
    document.getElementById('task-notes').value = (t && t.notes) ? t.notes : '';

    openModal('task-modal');
    setTimeout(function(){ document.getElementById('task-name').focus(); }, 50);
  }

  async function saveTaskFromModal(){
    var id = document.getElementById('task-id').value || uid();
    var isInterrupt = document.getElementById('task-is-interrupt').value === '1';

    var name = document.getElementById('task-name').value.trim();
    var sectionId = document.getElementById('task-section').value;
    var projectId = document.getElementById('task-project').value;
    var estimateMin = Number(document.getElementById('task-duration').value || 0);
    var dateRaw = document.getElementById('task-deadline').value || '';
    // ✅ date は「入力された値をそのまま保存」
    // （未設定にしたい場合は input を空にして保存する）
    var date = dateRaw;
    var repeat = document.getElementById('task-repeat').value;
    var status = document.getElementById('task-status').value;
    var actualMin = Number(document.getElementById('task-actual').value || 0);
    var priority = Number(document.getElementById('task-priority').value || 3);
    var notes = document.getElementById('task-notes').value.trim();

    if (!name){ toast('タスク名が必要です'); return; }
    if (!notes){ toast('備考は必須です'); return; }

    var idx = state.data.tasks.findIndex(function(t){ return t.id===id; });

    var base = {
      id: id,
      name: name,
      sectionId: sectionId,
      projectId: projectId,
      estimateMin: Math.max(0, estimateMin),
      actualMin: Math.max(0, actualMin),
      date: date || '',
      repeat: repeat,
      status: status,
      priority: priority,
      isInterrupt: isInterrupt,
      notes: notes,
      startedAt: null,
      updatedAt: new Date().toISOString(),
    };

    if (idx >= 0){
      var prev = state.data.tasks[idx];
      // ★追加：running → 非running に変えるなら、保存前に精算
    if (prev.status === 'running' && base.status === 'running') {
      base.startedAt = prev.startedAt;            // 維持
    } else if (prev.status !== 'running' && base.status === 'running') {
      base.startedAt = new Date().toISOString();  // runningへ遷移したので開始
    } else {
      base.startedAt = null;                      // running以外
    }
      if (prev.status === 'running' && base.status === 'running') base.startedAt = prev.startedAt;
      state.data.tasks[idx] = Object.assign({}, prev, base);
      toast('保存しました');
    } else {
      state.data.tasks.push(Object.assign({}, base, { createdAt: new Date().toISOString() }));
      toast('追加しました');
    }

    await persist();
    closeModal('task-modal');
setDateRange(state.data.ui.dateRange || 'today', true);
  }

  async function toggleComplete(taskId){
    var t = state.data.tasks.find(function(x){ return x.id===taskId; });
    if (!t) return;

    // ✅ 要件: 完了」を押すと running なら経過分を actualMin に加算してから completed
    if (t.status === 'completed'){
      // 既存の「戻す」は維持（pendingへ）
      setTaskStatus(t, 'pending');
    } else {
      if (t.status === 'running') finalizeRunningIfNeeded(t);
      setTaskStatus(t, 'completed');
    }
    await persist();
    renderAll();
  }

  async function deleteTask(taskId){
    if (!confirm('このタスクを削除しますか？')) return;
    state.data.tasks = state.data.tasks.filter(function(t){ return t.id!==taskId; });
    // サンプルは保存しない（クラウド上書き事故防止）
    // await persistNow({ reason: 'init_sample', allowEmpty: true });
    await persist();
    toast('削除しました');
    renderAll();
  }

  // ✅ モーダル内操作（一覧から移動した分）
  function getModalTaskId(){ return document.getElementById('task-id').value || null; }
  async function deleteTaskFromModal(){
    var id = getModalTaskId();
    if (!id){ toast('保存後に削除できます'); return; }
    await deleteTask(id);
    closeModal('task-modal');
  }
  async function postponeTaskFromModal(days){
    var id = getModalTaskId();
    if (!id){ toast('保存後に先送りできます'); return; }
    await postponeTask(id, days || 1);
    closeModal('task-modal');
  }
  async function loopTaskFromModal(){
    var id = getModalTaskId();
    if (!id){ toast('保存後にループできます'); return; }
    await loopTask(id);
    closeModal('task-modal');
  }
  function openProjectModal(projectId){
    projectId = projectId || null;
    var p = projectId ? state.data.projects.find(function(x){ return x.id===projectId; }) : null;
    document.getElementById('project-id').value = p ? p.id : '';
    document.getElementById('project-name').value = p ? p.name : '';
    openModal('project-modal');
    setTimeout(function(){ document.getElementById('project-name').focus(); }, 50);
  }

  async function saveProjectFromModal(){
    var id = document.getElementById('project-id').value || uid();
    var name = document.getElementById('project-name').value.trim();
    if (!name){ toast('プロジェクト名が必要です'); return; }

    var dup = state.data.projects.find(function(p){ return p.name===name && p.id!==id; });
    if (dup){ toast('同名プロジェクトがあります'); return; }

    var idx = state.data.projects.findIndex(function(p){ return p.id===id; });
    if (idx>=0) state.data.projects[idx].name = name;
    else state.data.projects.push({ id: id, name: name });

    await persist();
    closeModal('project-modal');
    renderProjects();
    toast('プロジェクトを保存');
  }

  /*********************
   * 12) Export / Backup
   *********************/
  function exportToCSV(){
    var rows = [[ 'id','name','project','section','estimateMin','actualMin','date','repeat','status','priority','isInterrupt','notes','createdAt','updatedAt','startedAt' ]];
    state.data.tasks.forEach(function(t){
      rows.push([
        t.id,
        t.name,
        (getProject(t.projectId) && getProject(t.projectId).name) ? getProject(t.projectId).name : '',
        (getSection(t.sectionId) && getSection(t.sectionId).name) ? getSection(t.sectionId).name : '',
        t.estimateMin ?? 0,
        t.actualMin ?? 0,
        t.date || '',
        t.repeat || 'none',
        t.status || 'pending',
        t.priority ?? 3,
        t.isInterrupt ? 1 : 0,
        String(t.notes||'').replaceAll('\n','\\n'),
        t.createdAt || '',
        t.updatedAt || '',
        t.startedAt || ''
      ]);
    });

    var csv = rows.map(function(r){
      return r.map(function(v){
        var s = String(v ?? '');
        return (s.includes(',') || s.includes('"') || s.includes('\n')) ? '"' + s.replaceAll('"','""') + '"' : s;
      }).join(',');
    }).join('\n');

    var blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'taskchute_' + nowISODate() + '.csv';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
  }

  function backupJSON(){
    var blob = new Blob([JSON.stringify(state.data, null, 2)], {type:'application/json'});
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'taskchute_backup_' + nowISODate() + '.json';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
  }

  async function restoreJSON(event){
    var file = event.target.files && event.target.files[0];
    if (!file) return;
    try {
      var text = await file.text();
      var obj = JSON.parse(text);
      state.data = normalizeData(obj);
      await persistNow({ reason: 'restoreJSON', allowEmpty: true });
      hydrateSelectors();
      renderProjects();
      renderAll();
      toast('復元しました');
    } catch {
      toast('復元に失敗しました');
    } finally {
      event.target.value = '';
    }
  }

  async function clearData(){
    if (!confirm('全データを消去します。よろしいですか？')) return;
    await storage.clear();
    location.reload();
  }

  /*********************
   * 13) Tests
   *********************/
  function assert(cond, msg){ if (!cond) throw new Error(msg || 'assertion failed'); }

  async function runTests(){
    __TEST_MODE__ = true; // ★追加：保存を止める
  try {
    var snapshot = JSON.parse(JSON.stringify(state.data));
    state.data.tasks = [];
    var today = nowISODate();

    state.data.tasks.push({
      id: 't1', name: 'A', sectionId: 'morning', projectId: 'inbox', estimateMin: 10, actualMin: 0,
      date: today, repeat: 'none', status: 'pending', priority: 3, isInterrupt: false,
      notes: 'ok', createdAt: new Date().toISOString(), updatedAt: new Date().toISOString(), startedAt: null
    });
    state.data.tasks.push({
      id: 't2', name: 'B', sectionId: 'forenoon', projectId: 'inbox', estimateMin: 5, actualMin: 0,
      date: today, repeat: 'none', status: 'running', priority: 3, isInterrupt: true,
      notes: 'ok', createdAt: new Date().toISOString(), updatedAt: new Date().toISOString(),
      startedAt: new Date(Date.now()-5*60000).toISOString()
    });

    state.data.ui.dateRange = 'today';
    document.getElementById('filter-completed').checked = true;
    document.getElementById('filter-uncompleted-only').checked = false;
    renderAll();

    assert(document.querySelector('[aria-label="start"]') !== null, 'start button should exist');

    // ✅ 実績合計に running の経過が加味される
    var actualText = document.getElementById('total-actual').textContent;
    assert(actualText.includes('0h 05m') || actualText.includes('0h 06m') || actualText.includes('0h 04m'),
      'total-actual should include running elapsed');

    // ✅ 追加ケース：toggleComplete が running を精算して completed にする
    await toggleComplete('t2');
    var t2 = state.data.tasks.find(x => x.id === 't2');
    assert(t2.status === 'completed', 't2 should be completed after toggleComplete');
    assert((t2.actualMin || 0) >= 4, 't2 actualMin should include elapsed minutes');

    // evening rule（※morning が対象かは仕様次第）
    var evening = new Date();
    evening.setHours(19,0,0,0);
    enforceEveningRule(evening);

    // loop
    await loopTask('t1');
    var created = state.data.tasks.find(function(x){
      return x.name==='A' && x.id!=='t1' && x.status==='pending';
    });
    assert(!!created, 'loop should create a new pending task');
    assert(created.sectionId === 'morning', 'loop should keep same section');

    toast('テストOK');
  } catch (e){
    console.error('Tests failed', e);
    toast('テスト失敗: ' + (e && e.message ? e.message : e));
  } finally {
    // ★必ず元に戻す
    state.data = snapshot;
    hydrateSelectors();
    renderProjects();
    renderAll();
    __TEST_MODE__ = false; // ★追加：テストモード解除
  }
}
  
  /*********************
   * 14) Boot + ticker
   *********************/
  var runningInterval = null;
 function startTicker(){
  if (runningInterval) return;
    runningInterval = setInterval(function(){
    enforceEveningRule(new Date());
    var hasRunning = state.data.tasks.some(function(t){
      return t.status === 'running';
    });
    if (hasRunning) tickRunningUI();
  }, 30 * 1000);
}

  async function loadApp(){
    await refreshAuthChip();

    // Supabase設定なしならローカルで動かす
    if (!supabaseClient){
      var loadedLocal = await localAdapter.load();
      if (loadedLocal) state.data = normalizeData(loadedLocal);
      else {
        var today = nowISODate();
        state.data.tasks = [{
          id: uid(),
          name: '（例）今日の計画を立てる',
          sectionId: 'morning',
          projectId: 'inbox',
          estimateMin: 15,
          actualMin: 0,
          date: today,
          repeat: 'none',
          status: 'pending',
          priority: 3,
          isInterrupt: false,
          notes: '備考が必須です。ここに判断メモや条件を書きます。',
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString(),
          startedAt: null,
        }];
        await localAdapter.save(state.data);
      }

      hydrateSelectors();
      renderProjects();
      setDateRange(state.data.ui.dateRange || 'today', true);
      renderAll();
      startTicker();
      return;
    }

  // ✅ Supabaseありの場合：起動時は reconcileLocalAndCloud() を唯一の入口にする
  //    (Local/Cloud の newer 判定 → state.data 決定 → 必要に応じてミラー)
    await loadFromCloudThenRender();

 // loadFromCloudThenRender() 内で render までやっているのでここでは不要
    startTicker();
  // ✅ 認証イベントでは「UI更新 + クールダウン + 必要なら reconcile」だけ
  //    ※ここで storage.load() すると “ローカル優先→空保存→クラウド上書き” 事故が起きる
    supabaseClient.auth.onAuthStateChange(async function(event){
      startLoginCooldown();
      await refreshAuthChip();

      // ログイン/サインアウト直後は data を “再判定” してから描画
      // (ログイン時: クラウド優先 / サインアウト時: ローカルへフォールバック)
      if (event === 'SIGNED_IN' || event === 'SIGNED_OUT' || event === 'TOKEN_REFRESHED') {
        await loadFromCloudThenRender();
      } else {
        // それ以外はUIだけ更新で十分
        renderProjects();
       renderAll();
      }
    });
  }

  // ✅ HTMLのonclickから呼べるようにグローバル公開
  window.toggleSidebar = toggleSidebar;
  window.switchSidebarTab = switchSidebarTab;
  window.openQuickSearch = openQuickSearch;
  window.openAuthModal = openAuthModal;
  window.closeModal = closeModal;

  window.setDateRange = setDateRange;
  window.setProjectFilter = setProjectFilter;

  window.openTaskModal = openTaskModal;
  window.saveTaskFromModal = saveTaskFromModal;
  window.toggleComplete = toggleComplete;
  window.deleteTask = deleteTask;

  window.openProjectModal = openProjectModal;
  window.saveProjectFromModal = saveProjectFromModal;

  window.startTask = startTask;
  window.pauseTask = pauseTask;
  window.postponeTask = postponeTask;
  window.loopTask = loopTask;
  window.deleteTaskFromModal = deleteTaskFromModal;
  window.postponeTaskFromModal = postponeTaskFromModal;
  window.loopTaskFromModal = loopTaskFromModal;

  window.exportToCSV = exportToCSV;
  window.backupJSON = backupJSON;
  window.restoreJSON = restoreJSON;
  window.clearData = clearData;

  window.authSignIn = authSignIn;
  window.authSignUp = authSignUp;
  window.authSignOut = authSignOut;
  window.migrateLocalToCloud = migrateLocalToCloud;

  window.renderAll = renderAll;
  window.runTests = runTests;
    
  // ✅ ページ離脱時に最後の保存を試みる（無限再予約防止のため fromUnload:true）
 window.addEventListener('beforeunload', function(){
  // ローカルだけ保存（同期は次回起動時に reconcile で吸収）
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state.data));
});
  
  // start
    loadApp();

})();
</script>
</body>
</html>
