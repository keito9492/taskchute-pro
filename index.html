<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TaskChute Pro (Supabase Sync)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <!-- âœ… Supabase JS (UMD) : window.supabase ãŒå¿…ãšç”Ÿãˆã‚‹ç‰ˆ -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@300;400;500;700&display=swap');
    body { font-family: 'Inter','Noto Sans JP',sans-serif; background-color:#f8fafc; }

    .status-running { border-left:4px solid #3b82f6; background:#eff6ff; }
    .status-paused { border-left:4px solid #f59e0b; background:#fffbeb; }
    .status-completed { border-left:4px solid #10b981; background:#ecfdf5; opacity:0.75; }
    .status-pending { border-left:4px solid #cbd5e1; background:white; }
    .status-future { border-left:4px solid #94a3b8; background:#f1f5f9; opacity:0.9; }

    .custom-scroll::-webkit-scrollbar { width:6px; }
    .custom-scroll::-webkit-scrollbar-track { background:#f1f1f1; }
    .custom-scroll::-webkit-scrollbar-thumb { background:#cbd5e1; border-radius:10px; }

    .modal-bg { background-color: rgba(0,0,0,0.4); backdrop-filter: blur(2px); }
    .tab-active { border-bottom:3px solid #2563eb; color:#2563eb; font-weight:800; }

    .sidebar-transition { transition: transform 0.3s ease-in-out; }
    @media (max-width:1024px){
      .sidebar-hidden { transform: translateX(-100%); }
      .sidebar-overlay { display:none; }
      .sidebar-open .sidebar-overlay { display:block; }
    }

    .fab { position:fixed; bottom:2rem; right:2rem; z-index:40; }
    .view-btn.active { background:#3b82f6; color:white; }

    @media (min-width:1025px){
      .task-card:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
      .task-actions { opacity:0; transition: opacity 0.2s; }
      .task-card:hover .task-actions { opacity:1; }
    }

    .scrollbar-hide::-webkit-scrollbar{ display:none; }
    .scrollbar-hide{ -ms-overflow-style:none; scrollbar-width:none; }

    .toast { position: fixed; left: 50%; transform: translateX(-50%); bottom: 1.25rem; z-index: 60; }
  </style>
</head>
<body class="h-screen overflow-hidden flex flex-col text-slate-900">

  <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/20 backdrop-blur-sm z-10 hidden sidebar-overlay"></div>

  <header class="bg-white border-b px-4 py-3 flex justify-between items-center shadow-sm z-30">
    <div class="flex items-center gap-3">
      <button onclick="toggleSidebar()" class="p-2 hover:bg-slate-100 rounded-lg lg:hidden" aria-label="menu">
        <i class="fas fa-bars text-xl text-slate-600"></i>
      </button>
      <div class="bg-blue-600 p-2 rounded-lg"><i class="fas fa-clock text-white text-lg"></i></div>
      <div>
        <h1 class="font-bold text-lg tracking-tight">TaskChute <span class="text-blue-600">Pro</span></h1>
        <p class="text-[10px] text-slate-500">æœ€çµ‚çµ‚äº†äºˆå®š: <span id="finish-estimate" class="font-semibold text-blue-600">--:--</span></p>
      </div>
    </div>

    <div class="flex items-center gap-3">
      <div class="hidden sm:flex bg-slate-100 p-1 rounded-lg">
        <button onclick="setDateRange('today')" id="btn-today" class="view-btn px-4 py-1.5 text-xs font-bold rounded-md transition active">ä»Šæ—¥</button>
        <button onclick="setDateRange('week')" id="btn-week" class="view-btn px-4 py-1.5 text-xs font-bold rounded-md transition text-slate-500">ä»Šé€±</button>
        <button onclick="setDateRange('undated')" id="btn-undated" class="view-btn px-4 py-1.5 text-xs font-bold rounded-md transition text-slate-500">æœªè¨­å®š</button>
      </div>

      <button onclick="openQuickSearch()" class="p-2 hover:bg-slate-100 rounded-lg" aria-label="search">
        <i class="fas fa-magnifying-glass text-slate-600"></i>
      </button>

      <button id="auth-chip" onclick="openAuthModal()" class="hidden sm:flex items-center gap-2 px-3 py-2 rounded-xl border hover:bg-slate-50 text-xs font-bold text-slate-700" aria-label="auth">
        <i class="fas fa-user"></i>
        <span id="auth-label">æœªãƒ­ã‚°ã‚¤ãƒ³</span>
      </button>
    </div>
  </header>

  <div class="flex-1 flex overflow-hidden relative">

    <aside id="sidebar" class="w-72 bg-white border-r flex flex-col fixed inset-y-0 left-0 z-20 sidebar-transition sidebar-hidden lg:relative lg:translate-x-0">
      <div class="flex border-b text-center text-[11px] font-bold uppercase tracking-wider text-slate-400">
        <button onclick="switchSidebarTab('plan')" id="tab-plan" class="flex-1 py-4 tab-active">è¡¨ç¤ºè¨­å®š</button>
        <button onclick="switchSidebarTab('sync')" id="tab-sync" class="flex-1 py-4">åŒæœŸãƒ»ç®¡ç†</button>
      </div>

      <div id="sidebar-content" class="flex-1 overflow-y-auto custom-scroll p-4 space-y-6">

        <div id="view-plan" class="space-y-6">
          <section>
            <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">è¡¨ç¤ºãƒ•ã‚£ãƒ«ã‚¿</h3>
            <div class="space-y-3 bg-slate-50 p-3 rounded-xl border border-slate-100">
              <label class="flex items-center justify-between cursor-pointer">
                <span class="text-xs font-bold text-slate-600">å®Œäº†æ¸ˆã¿ã‚’è¡¨ç¤º</span>
                <input type="checkbox" id="filter-completed" checked onchange="renderAll()" class="w-4 h-4 accent-blue-600" />
              </label>
              <label class="flex items-center justify-between cursor-pointer pt-2 border-t">
                <span class="text-xs font-bold text-slate-600">å…¨æœªå®Œäº†ã‚’è¡¨ç¤º</span>
                <input type="checkbox" id="filter-uncompleted-only" onchange="renderAll()" class="w-4 h-4 accent-red-600" />
              </label>
            </div>
          </section>

          <section>
            <div class="flex justify-between items-center mb-3">
              <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</h3>
              <button onclick="openProjectModal()" class="text-blue-600 hover:text-blue-700 transition" aria-label="add project">
                <i class="fas fa-plus-circle"></i>
              </button>
            </div>
            <div id="project-list" class="space-y-1"></div>
            <div class="mt-2">
              <button onclick="setProjectFilter(null)" class="w-full text-[10px] font-bold py-2 rounded-lg bg-slate-50 hover:bg-slate-100 border text-slate-600">ãƒ•ã‚£ãƒ«ã‚¿è§£é™¤</button>
            </div>
          </section>

          <section>
            <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">ä¿å­˜æ–¹å¼</h3>
            <div class="bg-slate-50 p-3 rounded-xl border border-slate-100 space-y-2">
              <div class="text-[11px] text-slate-600 leading-relaxed">
                ã“ã®ç‰ˆã¯ <b>Supabaseï¼ˆãƒ­ã‚°ã‚¤ãƒ³å¿…é ˆï¼‰</b> ã§PC/ã‚¹ãƒãƒ›åŒæœŸã—ã¾ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„å ´åˆã¯ <b>LocalStorage</b> ã«é€€é¿ã—ã¾ã™ã€‚
              </div>
              <div class="flex items-center justify-between">
                <span class="text-xs font-bold text-slate-600">ç¾åœ¨: <span id="storage-mode">---</span></span>
                <button onclick="openAuthModal()" class="text-xs font-bold text-blue-600 hover:text-blue-700">ãƒ­ã‚°ã‚¤ãƒ³</button>
              </div>
            </div>
          </section>
        </div>

        <div id="view-sync" class="hidden p-4 space-y-4">
          <button onclick="exportToCSV()" class="w-full bg-slate-100 text-slate-600 text-[10px] font-bold py-2 rounded-lg hover:bg-slate-200 transition">CSVå‡ºåŠ›</button>
          <button onclick="backupJSON()" class="w-full bg-slate-100 text-slate-600 text-[10px] font-bold py-2 rounded-lg hover:bg-slate-200 transition">JSONãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
          <label class="block">
            <span class="text-[10px] font-bold text-slate-500">JSONå¾©å…ƒ</span>
            <input type="file" accept="application/json" onchange="restoreJSON(event)" class="mt-1 w-full text-xs" />
          </label>
          <button onclick="clearData()" class="w-full bg-red-50 text-red-600 text-[10px] font-bold py-2 rounded-lg hover:bg-red-100 transition">å…¨ãƒ‡ãƒ¼ã‚¿æ¶ˆå»</button>

          <div class="pt-2 border-t">
            <p class="text-[10px] font-bold text-slate-500 mb-2">ãƒ‡ãƒãƒƒã‚°</p>
            <button onclick="runTests()" class="w-full bg-slate-900 text-white text-[10px] font-bold py-2 rounded-lg hover:bg-slate-800 transition">ç°¡æ˜“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
          </div>
        </div>

      </div>
    </aside>

    <main class="flex-1 flex flex-col bg-slate-50 relative overflow-hidden">
      <div class="p-3 flex gap-3 bg-white border-b overflow-x-auto whitespace-nowrap scrollbar-hide">
        <div class="flex-1 min-w-[120px] bg-slate-50 p-2 rounded-lg border text-center">
          <p class="text-[9px] text-slate-400 font-bold mb-0.5">è¦‹ç©åˆè¨ˆ</p>
          <p class="text-sm font-bold" id="total-estimate">0h 00m</p>
        </div>
        <div class="flex-1 min-w-[120px] bg-slate-50 p-2 rounded-lg border text-center">
          <p class="text-[9px] text-slate-400 font-bold mb-0.5">å®Ÿç¸¾åˆè¨ˆ</p>
          <p class="text-sm font-bold" id="total-actual">0h 00m</p>
        </div>
        <div class="flex-1 min-w-[120px] bg-slate-50 p-2 rounded-lg border text-center">
          <p class="text-[9px] text-slate-400 font-bold mb-0.5">æœªè¨­å®šã‚¿ã‚¹ã‚¯</p>
          <p class="text-sm font-bold" id="undated-count">0</p>
        </div>
        <div class="flex-1 min-w-[120px] bg-slate-50 p-2 rounded-lg border text-center">
          <p class="text-[9px] text-slate-400 font-bold mb-0.5">å‰²ã‚Šè¾¼ã¿ä»¶æ•°</p>
          <p class="text-sm font-bold text-rose-600" id="interrupt-count">0</p>
        </div>
      </div>

      <div class="flex-1 overflow-y-auto custom-scroll p-4 md:px-12 py-8 max-w-5xl mx-auto w-full">
        <div class="sm:hidden flex bg-slate-100 p-1 rounded-lg mb-5">
          <button onclick="setDateRange('today')" id="btn-today-m" class="view-btn w-1/3 px-2 py-1.5 text-xs font-bold rounded-md transition active">ä»Šæ—¥</button>
          <button onclick="setDateRange('week')" id="btn-week-m" class="view-btn w-1/3 px-2 py-1.5 text-xs font-bold rounded-md transition text-slate-500">ä»Šé€±</button>
          <button onclick="setDateRange('undated')" id="btn-undated-m" class="view-btn w-1/3 px-2 py-1.5 text-xs font-bold rounded-md transition text-slate-500">æœªè¨­å®š</button>
        </div>

        <button onclick="openTaskModal(null, true)" class="w-full mb-8 py-4 bg-white border-2 border-dashed border-rose-200 text-rose-500 rounded-2xl text-xs font-black tracking-widest hover:bg-rose-50 transition flex items-center justify-center gap-2 shadow-sm">
          <i class="fas fa-bolt"></i> å‰²ã‚Šè¾¼ã¿ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ 
        </button>

        <div id="task-container"></div>
      </div>

      <button onclick="openTaskModal()" class="fab w-16 h-16 bg-blue-600 text-white rounded-full shadow-2xl flex items-center justify-center text-2xl hover:bg-blue-700 transition transform hover:scale-105 active:scale-95" aria-label="add task">
        <i class="fas fa-plus"></i>
      </button>
    </main>
  </div>

  <!-- Task Modal -->
  <div id="task-modal" class="fixed inset-0 modal-bg z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl w-full max-w-lg shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
      <div class="p-6 border-b flex justify-between items-center hookup bg-slate-50">
        <h3 class="text-xl font-bold text-slate-800" id="modal-title">ã‚¿ã‚¹ã‚¯è©³ç´°</h3>
        <button onclick="closeModal('task-modal')" class="text-slate-400 p-2 hover:bg-slate-200 rounded-full" aria-label="close"><i class="fas fa-times"></i></button>
      </div>

      <div class="p-6 md:p-8 space-y-5 overflow-y-auto custom-scroll" id="task-modal-body">
        <input type="hidden" id="task-id" />
        <input type="hidden" id="task-is-interrupt" />

        <div class="space-y-2">
          <label class="block text-[11px] font-black text-slate-400 uppercase tracking-widest">ã‚¿ã‚¹ã‚¯å</label>
          <input type="text" id="task-name" class="w-full border-2 border-slate-100 rounded-2xl p-4 outline-none focus:border-blue-500 bg-slate-50 font-bold" placeholder="ä½•ã‚’ã—ã¾ã™ã‹ï¼Ÿ" />
        </div>

        <div class="grid grid-cols-2 gap-4 md:gap-6">
          <div class="space-y-2">
            <label class="block text-[11px] font-black text-slate-400 uppercase tracking-widest">æ™‚é–“æ  (ã‚»ã‚¯ã‚·ãƒ§ãƒ³)</label>
            <select id="task-section" class="w-full border-2 border-slate-100 rounded-2xl p-4 bg-slate-50 text-sm outline-none focus:border-blue-500"></select>
          </div>
          <div class="space-y-2">
            <label class="block text-[11px] font-black text-slate-400 uppercase tracking-widest">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</label>
            <select id="task-project" class="w-full border-2 border-slate-100 rounded-2xl p-4 bg-slate-50 text-sm outline-none focus:border-blue-500"></select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4 md:gap-6">
          <div class="space-y-2">
            <label class="block text-[11px] font-black text-slate-400 uppercase tracking-widest">è¦‹ç© (åˆ†)</label>
            <input type="number" id="task-duration" min="0" class="w-full border-2 border-slate-100 rounded-2xl p-4 bg-slate-50 text-sm outline-none" placeholder="ä¾‹: 25" />
          </div>
          <div class="space-y-2">
            <label class="block text-[11px] font-black text-slate-400 uppercase tracking-widest">å®Ÿè¡Œäºˆå®šæ—¥</label>
            <input type="date" id="task-deadline" class="w-full border-2 border-slate-100 rounded-2xl p-4 bg-slate-50 text-sm outline-none" />
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4 md:gap-6">
          <div class="space-y-2">
            <label class="block text-[11px] font-black text-slate-400 uppercase tracking-widest">ãƒªãƒ”ãƒ¼ãƒˆ</label>
            <select id="task-repeat" class="w-full border-2 border-slate-100 rounded-2xl p-4 bg-slate-50 text-sm outline-none focus:border-blue-500">
              <option value="none">ãªã—</option>
              <option value="daily">æ¯æ—¥</option>
              <option value="weekday">å¹³æ—¥</option>
              <option value="weekly">æ¯é€±</option>
              <option value="monthly">æ¯æœˆ</option>
            </select>
          </div>
          <div class="space-y-2">
            <label class="block text-[11px] font-black text-slate-400 uppercase tracking-widest">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
            <select id="task-status" class="w-full border-2 border-slate-100 rounded-2xl p-4 bg-slate-50 text-sm outline-none focus:border-blue-500">
              <option value="pending">æœªç€æ‰‹</option>
              <option value="running">å®Ÿè¡Œä¸­</option>
              <option value="paused">ä¸­æ–­</option>
              <option value="completed">å®Œäº†</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4 md:gap-6">
          <div class="space-y-2">
            <label class="block text-[11px] font-black text-slate-400 uppercase tracking-widest">å®Ÿç¸¾ (åˆ†)</label>
            <input type="number" id="task-actual" min="0" class="w-full border-2 border-slate-100 rounded-2xl p-4 bg-slate-50 text-sm outline-none" placeholder="ä¾‹: 30" />
          </div>
          <div class="space-y-2">
            <label class="block text-[11px] font-black text-slate-400 uppercase tracking-widest">å„ªå…ˆåº¦</label>
            <select id="task-priority" class="w-full border-2 border-slate-100 rounded-2xl p-4 bg-slate-50 text-sm outline-none focus:border-blue-500">
              <option value="3">é€šå¸¸</option>
              <option value="2">ã‚„ã‚„é«˜</option>
              <option value="1">é«˜</option>
              <option value="4">ä½</option>
            </select>
          </div>
        </div>

        <div class="space-y-2">
          <label class="block text-[11px] font-black text-slate-400 uppercase tracking-widest">å‚™è€ƒï¼ˆå¿…é ˆï¼‰</label>
          <textarea id="task-notes" rows="4" class="w-full border-2 border-slate-100 rounded-2xl p-4 outline-none focus:border-blue-500 bg-slate-50 text-sm" placeholder="ä½œæ¥­æ¡ä»¶ã€åˆ¤æ–­ãƒ¡ãƒ¢ã€æ°—ã¥ãâ€¦ï¼ˆç©ºã¯ä¿å­˜ã§ãã¾ã›ã‚“ï¼‰"></textarea>
          <p class="text-[11px] text-slate-500">â€»ã€Œå‚™è€ƒå¿…é ˆã€ãƒ«ãƒ¼ãƒ«ã§ã€ç©ºæ¬„ã®ã¾ã¾ä¿å­˜ã§ãã¾ã›ã‚“ã€‚</p>
        </div>

        <div class="flex gap-3 pt-2">
          <button onclick="saveTaskFromModal()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-2xl">ä¿å­˜</button>
          <button onclick="closeModal('task-modal')" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-3 rounded-2xl">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>

        <!-- âœ… ã“ã“ã‹ã‚‰: ä¸€è¦§ã‹ã‚‰ç§»ã—ãŸæ“ä½œï¼ˆå‰Šé™¤/å…ˆé€ã‚Š/ãƒ«ãƒ¼ãƒ—ï¼‰ -->
        <div class="pt-6 mt-2 border-t space-y-3">
          <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">æ“ä½œ</p>
          <div class="grid grid-cols-2 gap-3">
            <button id="modal-postpone-btn"
              onclick="postponeTaskFromModal(1)"
              class="bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-3 rounded-2xl text-sm">
              <i class="fas fa-forward mr-1"></i> å…ˆé€ã‚Šï¼ˆ+1æ—¥ï¼‰
            </button>
            <button id="modal-loop-btn"
              onclick="loopTaskFromModal()"
              class="bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-3 rounded-2xl text-sm">
              <i class="fas fa-rotate-right mr-1"></i> ãƒ«ãƒ¼ãƒ—
            </button>
          </div>
          <button id="modal-delete-btn"
            onclick="deleteTaskFromModal()"
            class="w-full bg-red-50 hover:bg-red-100 text-red-700 font-black py-3 rounded-2xl text-sm">
            <i class="fas fa-trash mr-1"></i> ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤
          </button>
          <p class="text-[11px] text-slate-500">â€»å‰Šé™¤ã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚å¿…è¦ãªã‚‰å…ˆé€ã‚Šã§é€ƒãŒã™ã®ãŒå®‰å…¨ã§ã™ã€‚</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Project Modal -->
  <div id="project-modal" class="fixed inset-0 modal-bg z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl w-full max-w-md shadow-2xl overflow-hidden">
      <div class="p-6 border-b flex justify-between items-center bg-slate-50">
        <h3 class="text-lg font-bold text-slate-800">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</h3>
        <button onclick="closeModal('project-modal')" class="text-slate-400 p-2 hover:bg-slate-200 rounded-full" aria-label="close"><i class="fas fa-times"></i></button>
      </div>
      <div class="p-6 space-y-4">
        <input type="hidden" id="project-id" />
        <div class="space-y-2">
          <label class="block text-[11px] font-black text-slate-400 uppercase tracking-widest">åç§°</label>
          <input type="text" id="project-name" class="w-full border-2 border-slate-100 rounded-2xl p-4 outline-none focus:border-blue-500 bg-slate-50 font-bold" placeholder="ä¾‹: æƒ…ã‚·ã‚¹æ”¹å–„" />
        </div>
        <div class="flex gap-3">
          <button onclick="saveProjectFromModal()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-2xl">ä¿å­˜</button>
          <button onclick="closeModal('project-modal')" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-3 rounded-2xl">é–‰ã˜ã‚‹</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Search Modal -->
  <div id="search-modal" class="fixed inset-0 modal-bg z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl w-full max-w-lg shadow-2xl overflow-hidden">
      <div class="p-6 border-b flex justify-between items-center bg-slate-50">
        <h3 class="text-lg font-bold text-slate-800">æ¤œç´¢</h3>
        <button onclick="closeModal('search-modal')" class="text-slate-400 p-2 hover:bg-slate-200 rounded-full" aria-label="close"><i class="fas fa-times"></i></button>
      </div>
      <div class="p-6 space-y-3">
        <input id="search-q" oninput="renderAll()" type="text" class="w-full border-2 border-slate-100 rounded-2xl p-4 outline-none focus:border-blue-500 bg-slate-50" placeholder="ã‚¿ã‚¹ã‚¯å / å‚™è€ƒ / ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆâ€¦" />
        <p class="text-[11px] text-slate-500">ESCã§é–‰ã˜ã¾ã™</p>
      </div>
    </div>
  </div>

  <!-- Auth Modal -->
  <div id="auth-modal" class="fixed inset-0 modal-bg z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl w-full max-w-md shadow-2xl overflow-hidden">
      <div class="p-6 border-b flex justify-between items-center bg-slate-50">
        <h3 class="text-lg font-bold text-slate-800">ãƒ­ã‚°ã‚¤ãƒ³</h3>
        <button onclick="closeModal('auth-modal')" class="text-slate-400 p-2 hover:bg-slate-200 rounded-full" aria-label="close"><i class="fas fa-times"></i></button>
      </div>
      <div class="p-6 space-y-4">
        <div class="text-[12px] text-slate-600 leading-relaxed">
          PC/ã‚¹ãƒãƒ›ã§åŒæœŸã™ã‚‹ãŸã‚ã€Supabaseã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã€‚<br />
          æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒç«¯æœ«å†…ã«ã‚ã‚‹å ´åˆã¯ã€ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«ã€Œã‚¯ãƒ©ã‚¦ãƒ‰ã¸ç§»è¡Œã€ã§ãã¾ã™ã€‚
        </div>

        <div class="space-y-2">
          <label class="block text-[11px] font-black text-slate-400 uppercase tracking-widest">Email</label>
          <input id="auth-email" type="email" class="w-full border-2 border-slate-100 rounded-2xl p-4 outline-none focus:border-blue-500 bg-slate-50" placeholder="you@example.com" />
        </div>

        <div class="space-y-2">
          <label class="block text-[11px] font-black text-slate-400 uppercase tracking-widest">Password</label>
          <input id="auth-pass" type="password" class="w-full border-2 border-slate-100 rounded-2xl p-4 outline-none focus:border-blue-500 bg-slate-50" placeholder="password" />
          <p class="text-[11px] text-slate-500">åˆå›ã¯ã€Œæ–°è¦ç™»éŒ²ã€ã§ä½œã‚Œã¾ã™</p>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <button onclick="authSignIn()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-2xl">ãƒ­ã‚°ã‚¤ãƒ³</button>
          <button onclick="authSignUp()" class="bg-slate-900 hover:bg-slate-800 text-white font-bold py-3 rounded-2xl">æ–°è¦ç™»éŒ²</button>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <button onclick="migrateLocalToCloud()" class="bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-3 rounded-2xl">ã‚¯ãƒ©ã‚¦ãƒ‰ã¸ç§»è¡Œ</button>
          <button onclick="authSignOut()" class="bg-red-50 hover:bg-red-100 text-red-700 font-bold py-3 rounded-2xl">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>

        <div class="text-[11px] text-slate-500">
          ç¾åœ¨ã®ä¿å­˜: <b id="auth-storage">---</b>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast hidden"><div class="bg-slate-900 text-white text-sm px-4 py-2 rounded-xl shadow-xl"></div></div>

<script>
(function(){
  'use strict';

  /*********************
   * 0) Supabase configï¼ˆã“ã“ã‚’ç½®æ›ï¼‰
   *********************/
  // âœ… ã“ã“ã¯å¿…ãšå®šç¾©ã•ã‚Œã‚‹ã‚ˆã†ã« var ã«ã—ã¦ã„ã¾ã™ï¼ˆTDZå¯¾ç­–ï¼‰
  var SUPABASE_URL = 'https://opjgyixsmdbnmkwbxruy.supabase.co';
  var SUPABASE_ANON_KEY = 'sb_publishable_hQMgGP5NXKYOZUYf8938Jw_5MzJMhWA';

  // âœ… supabase clientï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼šäºŒé‡èª­ã¿è¾¼ã¿ã§ã‚‚è½ã¡ãªã„ï¼‰
  var supabaseClient = window.__TASKCHUTE_SUPABASE_CLIENT || null;
  try {
    var canInit = (typeof SUPABASE_URL === 'string' && SUPABASE_URL.startsWith('http') && !SUPABASE_URL.includes('REPLACE_'));
    if (!supabaseClient && canInit && window.supabase && typeof window.supabase.createClient === 'function') {
      supabaseClient = window.__TASKCHUTE_SUPABASE_CLIENT = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }
  } catch (e) {
    console.error('Supabase init failed', e);
    supabaseClient = null;
  }

  /*********************
   * 1) Storage adapters
   *********************/
  var STORAGE_KEY = 'taskchute_pro_v1_local';

  function LocalStorageAdapter(){}
  LocalStorageAdapter.prototype.load = async function(){
    var raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return null;
    try { return JSON.parse(raw); } catch { return null; }
  };
  LocalStorageAdapter.prototype.save = async function(data){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  };
  LocalStorageAdapter.prototype.clear = async function(){
    localStorage.removeItem(STORAGE_KEY);
  };

  function SupabaseAdapter(client){ this.client = client; }
  SupabaseAdapter.prototype.load = async function(){
    if (!this.client) return null;
    var sessionData = await this.client.auth.getSession();
    var user = sessionData && sessionData.data && sessionData.data.session && sessionData.data.session.user;
    if (!user) return null;

    var res = await this.client.from('user_data').select('data').eq('user_id', user.id).maybeSingle();
    if (res.error) throw res.error;
    return (res.data && res.data.data) ? res.data.data : null;
  };
  SupabaseAdapter.prototype.save = async function(stateData){
    if (!this.client) return;
    var sessionData = await this.client.auth.getSession();
    var user = sessionData && sessionData.data && sessionData.data.session && sessionData.data.session.user;
    if (!user) throw new Error('not authenticated');

    var res = await this.client.from('user_data')
      .upsert({ user_id: user.id, data: stateData, updated_at: new Date().toISOString() }, { onConflict: 'user_id' });
    if (res.error) throw res.error;
  };
  SupabaseAdapter.prototype.clear = async function(){
    if (!this.client) return;
    var sessionData = await this.client.auth.getSession();
    var user = sessionData && sessionData.data && sessionData.data.session && sessionData.data.session.user;
    if (!user) return;

    var res = await this.client.from('user_data').delete().eq('user_id', user.id);
    if (res.error) throw res.error;
  };

  function HybridAdapter(local, cloud, client){
    this.local = local;
    this.cloud = cloud;
    this.client = client;
  }
  HybridAdapter.prototype.isAuthed = async function(){
    if (!this.client) return false;
    var s = await this.client.auth.getSession();
    return !!(s && s.data && s.data.session && s.data.session.user);
  };
  HybridAdapter.prototype.load = async function(){
    if (await this.isAuthed()) { setStorageModeUI('Supabase'); return await this.cloud.load(); }
    setStorageModeUI('LocalStorage');
    return await this.local.load();
  };
  HybridAdapter.prototype.save = async function(data){
    if (await this.isAuthed()) { setStorageModeUI('Supabase'); return await this.cloud.save(data); }
    setStorageModeUI('LocalStorage');
    return await this.local.save(data);
  };
  HybridAdapter.prototype.clear = async function(){
    if (await this.isAuthed()) { setStorageModeUI('Supabase'); return await this.cloud.clear(); }
    setStorageModeUI('LocalStorage');
    return await this.local.clear();
  };

  var localAdapter = new LocalStorageAdapter();
  var cloudAdapter = new SupabaseAdapter(supabaseClient);
  var storage = new HybridAdapter(localAdapter, cloudAdapter, supabaseClient);

  /*********************
   * 2) Utils
   *********************/
  function nowISODate(){ return new Date().toISOString().slice(0,10); }
  function uid(){
  var c = (typeof crypto !== 'undefined') ? crypto : null;
  return (c && c.randomUUID) ? c.randomUUID()
   : (Date.now().toString(36) + Math.random().toString(36).slice(2));
  }

  function addDaysISO(iso, days){
    var d = new Date(iso + 'T00:00:00');
    d.setDate(d.getDate() + days);
    var y = d.getFullYear();
    var mo = String(d.getMonth()+1).padStart(2,'0');
    var da = String(d.getDate()).padStart(2,'0');
    return y + '-' + mo + '-' + da;
  }

  function setStorageModeUI(mode){
    var el = document.getElementById('storage-mode');
    var el2 = document.getElementById('auth-storage');
    if (el) el.textContent = mode;
    if (el2) el2.textContent = mode;
  }

  function toast(msg){
    var root = document.getElementById('toast');
    var box = root.querySelector('div');
    box.textContent = msg;
    root.classList.remove('hidden');
    setTimeout(function(){ root.classList.add('hidden'); }, 1800);
  }

  function escapeHtml(str){
    return String(str ?? '')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#39;');
  }

  function fmtMin(min){
    var m = Number(min)||0;
    var h = Math.floor(m/60);
    var mm = m%60;
    return h + 'h ' + String(mm).padStart(2,'0') + 'm';
  }

  function prettyDate(iso){
    try {
      var d = new Date(iso + 'T00:00:00');
      var w = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][d.getDay()];
      return d.getFullYear() + '/' + String(d.getMonth()+1).padStart(2,'0') + '/' + String(d.getDate()).padStart(2,'0') + ' (' + w + ')';
    } catch {
      return iso;
    }
  }

  function elapsedMinSince(iso){
    if (!iso) return 0;
    var start = new Date(iso).getTime();
    if (!Number.isFinite(start)) return 0;
    var diffMs = Date.now() - start;
    return Math.max(0, Math.floor(diffMs / 60000));
  }

  /*********************
   * 3) Sections + time windows
   *********************/
  var DEFAULT_SECTIONS = [
    { id: 'morning', name: 'æœ' },
    { id: 'forenoon', name: 'åˆå‰' },
    { id: 'afternoon', name: 'åˆå¾Œ' },
    { id: 'evening', name: 'å¤œ' },
  ];

  var SECTION_BOUNDARIES_MIN = {
    morningStart: 5 * 60,
    forenoonStart: 9 * 60 + 30,
    afternoonStart: 13 * 60,
    eveningStart: 18 * 60 + 30,
  };

  function classifyTimeToSectionId(dateObj){
    var t = dateObj.getHours() * 60 + dateObj.getMinutes();
    if (t >= SECTION_BOUNDARIES_MIN.eveningStart || t < SECTION_BOUNDARIES_MIN.morningStart) return 'evening';
    if (t >= SECTION_BOUNDARIES_MIN.afternoonStart) return 'afternoon';
    if (t >= SECTION_BOUNDARIES_MIN.forenoonStart) return 'forenoon';
    return 'morning';
  }

  /*********************
   * 4) State (varã§TDZå›é¿)
   *********************/
  var state = {
    data: {
      meta: { version: 1, updatedAt: new Date().toISOString() },
      projects: [ { id: 'inbox', name: 'INBOX' } ],
      sections: DEFAULT_SECTIONS,
      tasks: [],
      ui: { dateRange: 'today', projectFilter: null }
    }
  };

  function normalizeData(d){
    var safe = (d && typeof d === 'object') ? d : {};
    var projects = Array.isArray(safe.projects) ? safe.projects : [ {id:'inbox', name:'INBOX'} ];
    var sections = Array.isArray(safe.sections) ? safe.sections : DEFAULT_SECTIONS;
    var tasks = Array.isArray(safe.tasks) ? safe.tasks : [];
    var ui = (safe.ui && typeof safe.ui === 'object') ? safe.ui : { dateRange:'today', projectFilter:null };
    return { meta: { version: 1, updatedAt: new Date().toISOString() }, projects: projects, sections: sections, tasks: tasks, ui: ui };
  }

  async function persist(){
    state.data.meta.updatedAt = new Date().toISOString();
    try {
      await storage.save(state.data);
    } catch (e) {
      console.error(e);
      toast('ä¿å­˜ã«å¤±æ•—ï¼ˆãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç¢ºèªï¼‰');
    }
  }

  /*********************
   * 5) UI base
   *********************/
  function openModal(id){ document.getElementById(id).classList.remove('hidden'); }
  function closeModal(id){
    document.getElementById(id).classList.add('hidden');
    if (id === 'search-modal') document.getElementById('search-q').value = '';
  }

  function toggleSidebar(){
    var sidebar = document.getElementById('sidebar');
    var overlay = document.getElementById('sidebar-overlay');
    var opened = !sidebar.classList.contains('sidebar-hidden');
    if (opened){
      sidebar.classList.add('sidebar-hidden');
      overlay.classList.add('hidden');
      document.body.classList.remove('sidebar-open');
    } else {
      sidebar.classList.remove('sidebar-hidden');
      overlay.classList.remove('hidden');
      document.body.classList.add('sidebar-open');
    }
  }

  function switchSidebarTab(tab){
    var tabPlan = document.getElementById('tab-plan');
    var tabSync = document.getElementById('tab-sync');
    var viewPlan = document.getElementById('view-plan');
    var viewSync = document.getElementById('view-sync');

    if (tab === 'plan'){
      tabPlan.classList.add('tab-active');
      tabSync.classList.remove('tab-active');
      viewPlan.classList.remove('hidden');
      viewSync.classList.add('hidden');
    } else {
      tabSync.classList.add('tab-active');
      tabPlan.classList.remove('tab-active');
      viewSync.classList.remove('hidden');
      viewPlan.classList.add('hidden');
    }
  }

  function openQuickSearch(){
    openModal('search-modal');
    setTimeout(function(){ document.getElementById('search-q').focus(); }, 50);
  }

  document.addEventListener('keydown', function(e){
    if (e.key === 'Escape'){
      ['task-modal','project-modal','search-modal','auth-modal'].forEach(function(id){
        var el = document.getElementById(id);
        if (el && !el.classList.contains('hidden')) closeModal(id);
      });
    }
  });

  /*********************
   * 6) Selectors
   *********************/
  function hydrateSelectors(){
    var sectionSel = document.getElementById('task-section');
    if (sectionSel){
      sectionSel.innerHTML = '';
      state.data.sections.forEach(function(s){
        var opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = s.name;
        sectionSel.appendChild(opt);
      });
    }

    var projSel = document.getElementById('task-project');
    if (projSel){
      projSel.innerHTML = '';
      state.data.projects.forEach(function(p){
        var opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = p.name;
        projSel.appendChild(opt);
      });
    }
  }

  function getProject(id){ return state.data.projects.find(function(p){ return p.id===id; }); }
  function getSection(id){ return state.data.sections.find(function(s){ return s.id===id; }); }

  /*********************
   * 7) Auth
   *********************/
  function openAuthModal(){
    if (!supabaseClient){
      toast('Supabaseè¨­å®šãŒæœªå…¥åŠ›ã§ã™');
      return;
    }
    openModal('auth-modal');
  }

  async function refreshAuthChip(){
    var chip = document.getElementById('auth-chip');
    var label = document.getElementById('auth-label');
    if (!chip || !label) return;

    chip.classList.remove('hidden');

    if (!supabaseClient){
      label.textContent = 'æœªè¨­å®š';
      return;
    }

    var s = await supabaseClient.auth.getSession();
    var user = s && s.data && s.data.session && s.data.session.user;
    if (user){
      label.textContent = user.email || 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­';
      setStorageModeUI('Supabase');
    } else {
      label.textContent = 'æœªãƒ­ã‚°ã‚¤ãƒ³';
      setStorageModeUI('LocalStorage');
    }
  }

  async function authSignIn(){
    if (!supabaseClient) return;
    var email = document.getElementById('auth-email').value.trim();
    var pass = document.getElementById('auth-pass').value;
    if (!email || !pass){ toast('Email/Passwordã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

    var res = await supabaseClient.auth.signInWithPassword({ email: email, password: pass });
    if (res.error){ toast('ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: ' + res.error.message); return; }

    toast('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ');
    await refreshAuthChip();
    await loadFromCloudThenRender();
    closeModal('auth-modal');
  }

  async function authSignUp(){
    if (!supabaseClient) return;
    var email = document.getElementById('auth-email').value.trim();
    var pass = document.getElementById('auth-pass').value;
    if (!email || !pass){ toast('Email/Passwordã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

    var res = await supabaseClient.auth.signUp({ email: email, password: pass });
    if (res.error){ toast('ç™»éŒ²å¤±æ•—: ' + res.error.message); return; }

    toast('ç™»éŒ²ã—ã¾ã—ãŸ');
    await refreshAuthChip();
    await loadFromCloudThenRender();
    closeModal('auth-modal');
  }

  async function authSignOut(){
    if (!supabaseClient) return;
    await supabaseClient.auth.signOut();
    toast('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ');
    await refreshAuthChip();

    var local = await localAdapter.load();
    if (local) state.data = normalizeData(local);
    
    renderProjects();
    setDateRange(state.data.ui.dateRange || 'today', true);
    renderAll();
     }

  async function migrateLocalToCloud(){
    if (!supabaseClient) return;
    var s = await supabaseClient.auth.getSession();
    var user = s && s.data && s.data.session && s.data.session.user;
    if (!user){ toast('å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„'); return; }

    var local = await localAdapter.load();
    if (!local){ toast('ç§»è¡Œã™ã‚‹ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return; }

    state.data = normalizeData(local);
    await persist();
    toast('ãƒ­ãƒ¼ã‚«ãƒ« â†’ ã‚¯ãƒ©ã‚¦ãƒ‰ã¸ç§»è¡Œã—ã¾ã—ãŸ');
    closeModal('auth-modal');
    renderProjects();
    renderAll();
  }

  async function loadFromCloudThenRender(){
    try {
      var loaded = await cloudAdapter.load();
      if (loaded) state.data = normalizeData(loaded);
      renderProjects();
      setDateRange(state.data.ui.dateRange || 'today', true);
      renderAll();
    } catch (e) {
      console.error(e);
      toast('ã‚¯ãƒ©ã‚¦ãƒ‰èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }

  /*********************
   * 8) Filters
   *********************/
  function setDateRange(range, skipPersist){
    state.data.ui.dateRange = range;

    ['today','week','undated'].forEach(function(k){
      var btn = document.getElementById('btn-'+k);
      var btnm = document.getElementById('btn-'+k+'-m');
      if (btn){ btn.classList.toggle('active', k===range); btn.classList.toggle('text-slate-500', k!==range); }
      if (btnm){ btnm.classList.toggle('active', k===range); btnm.classList.toggle('text-slate-500', k!==range); }
    });

    if (!skipPersist) persist();
    renderAll();
  }

  function setProjectFilter(projectId){
    state.data.ui.projectFilter = projectId;
    persist();
    renderProjects();
    renderAll();
  }

  function inWeek(dateStr){
    if (!dateStr) return false;
    var d = new Date(dateStr + 'T00:00:00');
    var now = new Date();
    var day = now.getDay();
    var diffToMon = (day === 0 ? -6 : 1 - day);
    var monday = new Date(now); monday.setHours(0,0,0,0); monday.setDate(now.getDate() + diffToMon);
    var sunday = new Date(monday); sunday.setDate(monday.getDate() + 6); sunday.setHours(23,59,59,999);
    return d >= monday && d <= sunday;
  }

  function matchesDateRange(task){
    var r = state.data.ui.dateRange;
    if (r === 'undated') return !task.date;
    if (r === 'today') return task.date === nowISODate();
    if (r === 'week') return inWeek(task.date);
    return true;
  }

  function isVisibleByFilters(task){
    var showCompleted = document.getElementById('filter-completed').checked;
    var uncompletedOnly = document.getElementById('filter-uncompleted-only').checked;

    if (!showCompleted && task.status === 'completed') return false;
    if (uncompletedOnly && task.status === 'completed') return false;

    var pf = state.data.ui.projectFilter;
    if (pf && task.projectId !== pf) return false;

    var qEl = document.getElementById('search-q');
    var q = (qEl ? qEl.value : '').trim().toLowerCase();
    if (q){
      var pj = (getProject(task.projectId) && getProject(task.projectId).name) ? getProject(task.projectId).name : '';
      var s = (task.name + ' ' + task.notes + ' ' + pj).toLowerCase();
      if (!s.includes(q)) return false;
    }

    return matchesDateRange(task);
  }

  /*********************
   * 9) Running controls
   *********************/
  function finalizeRunningIfNeeded(t){
    if (!t) return 0;
    if (t.status === 'running' && t.startedAt){
      var add = elapsedMinSince(t.startedAt);
      if (add > 0) t.actualMin = Math.max(0, Number(t.actualMin||0) + add);
      t.startedAt = null;
      return add;
    }
    return 0;
  }

  function setTaskStatus(t, nextStatus){
    if (!t) return;
    // running ã‹ã‚‰ã®é·ç§»ã¯å¿…ãšç²¾ç®—ã—ã¦ã‹ã‚‰
    if (t.status === 'running' && nextStatus !== 'running'){
    finalizeRunningIfNeeded(t);
    }
    t.status = nextStatus;
    if (nextStatus === 'running' && !t.startedAt){
      t.startedAt = new Date().toISOString();
    }
    if (nextStatus !== 'running'){
      t.startedAt = null;
    }
    t.updatedAt = new Date().toISOString();
  }
  
  function stopTask(taskId, opts){
    opts = opts || {};
    var t = state.data.tasks.find(function(x){ return x.id===taskId; });
    if (!t) return;

     // âœ… è¦ä»¶: åœæ­¢/ä¸­æ–­ã¯ â€œçµŒéã‚’ actualMin ã«åŠ ç®— â†’ startedAt=null â†’ pausedâ€
ã€€   // ãŸã ã—æ—¢å­˜åˆ©ç”¨ã‚‚ã‚ã‚‹ã®ã§ opts ã§æŒ‡å®šã•ã‚ŒãŸã‚‰ãã‚Œã«å¾“ã†
ã€€  finalizeRunningIfNeeded(t);
    if (opts.setPaused === true) setTaskStatus(t, 'paused');
    else if (opts.setPaused === false) setTaskStatus(t, 'pending');
    else setTaskStatus(t, 'paused');
  }

  async function startTask(taskId){
    var t = state.data.tasks.find(function(x){ return x.id===taskId; });
    if (!t) return;

    var running = state.data.tasks.find(function(x){ return x.status==='running' && x.id!==taskId; });
    // âœ… ä»–ã® running ãŒã„ãŸã‚‰ â€œä¸­æ–­ï¼ˆpausedï¼‰â€ ã«å¯„ã›ã‚‹ï¼ˆå®Ÿç¸¾ç²¾ç®—ã‚‚ç¢ºå®Ÿï¼‰
   if (running) stopTask(running.id, { setPaused: true });
 ã€€ã€€setTaskStatus(t, 'running');
    
    await persist();
    renderAll();
  }

  async function pauseTask(taskId){
    stopTask(taskId, { setPaused: true });
    await persist();
    renderAll();
  }

  async function postponeTask(taskId, days){
    days = days || 1;
    var t = state.data.tasks.find(function(x){ return x.id===taskId; });
    if (!t) return;

    if (t.status === 'running') stopTask(t.id, { setPaused: true });

    var base = t.date ? t.date : nowISODate();
    t.date = addDaysISO(base, days);
    t.updatedAt = new Date().toISOString();

    await persist();
    toast('å…ˆé€ã‚Šã—ã¾ã—ãŸï¼ˆ+1æ—¥ï¼‰');
    renderAll();
  }

  function enforceEveningRule(now){
    now = now || new Date();
    var current = classifyTimeToSectionId(now);
    if (current !== 'evening') return;

    var runningTask = state.data.tasks.find(function(t){ return t.status==='running'; });
    if (!runningTask) return;
    
    // âœ… å¤œãƒ«ãƒ¼ãƒ«ï¼šåœæ­¢ï¼ˆï¼ä¸­æ–­ï¼‰â†’ ç¿Œæ—¥+1æ—¥ â†’ åˆå‰ã¸
    stopTask(runningTask.id, { setPaused: true });

    var base = runningTask.date ? runningTask.date : nowISODate();
    runningTask.date = addDaysISO(base, 1);
    runningTask.sectionId = 'morning';
    runningTask.updatedAt = new Date().toISOString();
    persist();
    toast('å¤œã«ãªã£ãŸã®ã§åœæ­¢ â†’ ç¿Œæ—¥åˆå‰ã«å…ˆé€ã‚Šã—ã¾ã—ãŸ');
  }

  async function loopTask(taskId){
    var t = state.data.tasks.find(function(x){ return x.id===taskId; });
    if (!t) return;

    if (t.status === 'running') stopTask(t.id, { setPaused: true });

    t.status = 'completed';
    t.startedAt = null;
    t.updatedAt = new Date().toISOString();

    var baseDate = t.date ? t.date : nowISODate();
    var nextDate = addDaysISO(baseDate, 1);

    var newTask = JSON.parse(JSON.stringify(t));
    newTask.id = uid();
    newTask.date = nextDate;
    newTask.sectionId = 'forenoon';
    newTask.actualMin = 0;
    newTask.status = 'running';
    newTask.startedAt = new Date().toISOString();
    newTask.createdAt = new Date().toISOString();
    newTask.updatedAt = new Date().toISOString();

    state.data.tasks.push(newTask);

    await persist();
    toast('ãƒ«ãƒ¼ãƒ—: æ¬¡å›ã‚¿ã‚¹ã‚¯ï¼ˆåˆå‰ï¼‰ã‚’ä½œæˆã—ã¦é–‹å§‹ã—ã¾ã—ãŸ');
    renderAll();
  }

  /*********************
   * 10) Render
   *********************/
  function statusClass(task){
    if (task.status === 'completed') return 'status-completed';
    if (task.status === 'running') return 'status-running';
    if (task.status === 'paused') return 'status-paused';
    if (task.date && task.date > nowISODate()) return 'status-future';
    return 'status-pending';
  }

  function priorityBadge(p){
    var map = {
      1:['é«˜','bg-rose-100 text-rose-700'],
      2:['ã‚„ã‚„é«˜','bg-amber-100 text-amber-700'],
      3:['é€šå¸¸','bg-slate-100 text-slate-700'],
      4:['ä½','bg-slate-100 text-slate-500']
    };
    var tup = map[p] || map[3];
    return '<span class="text-[10px] font-bold px-2 py-0.5 rounded-full ' + tup[1] + '">' + tup[0] + '</span>';
  }

  function recomputeTotals(){
    var visible = state.data.tasks.filter(isVisibleByFilters);
    var est = visible.reduce(function(a,t){ return a + (Number(t.estimateMin)||0); }, 0);
    // âœ… å®Ÿç¸¾åˆè¨ˆï¼šè¡¨ç¤ºä¸­ actualMin ã®åˆè¨ˆ + running ã®çµŒéåˆ†ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¦‹ãˆï¼‰
    var act = visible.reduce(function(a,t){
    var base = Number(t.actualMin)||0;
    var extra = (t.status==='running' && t.startedAt) ? elapsedMinSince(t.startedAt) : 0;
    return a + base + extra;
    }, 0);
    document.getElementById('total-estimate').textContent = fmtMin(est);
    document.getElementById('total-actual').textContent = fmtMin(act);

    var undatedCount = state.data.tasks.filter(function(t){ return !t.date && t.status!=='completed'; }).length;
    document.getElementById('undated-count').textContent = String(undatedCount);

    var interruptCount = visible.filter(function(t){ return !!t.isInterrupt; }).length;
    document.getElementById('interrupt-count').textContent = String(interruptCount);

    var now = new Date();
    var finish = new Date(now.getTime() + est*60000);
    var hh = String(finish.getHours()).padStart(2,'0');
    var mm = String(finish.getMinutes()).padStart(2,'0');
    document.getElementById('finish-estimate').textContent = hh + ':' + mm;
  }

  function renderProjects(){
    var list = document.getElementById('project-list');
    var pf = state.data.ui.projectFilter;
    list.innerHTML = '';

    state.data.projects.slice().sort(function(a,b){ return a.name.localeCompare(b.name,'ja'); }).forEach(function(p){
      var count = state.data.tasks.filter(function(t){ return t.projectId===p.id && t.status!=='completed'; }).length;
      var active = pf === p.id;
      var btn = document.createElement('button');
      btn.className = 'w-full flex justify-between items-center px-3 py-2 rounded-xl text-xs font-bold border transition ' +
        (active ? 'bg-blue-50 border-blue-200 text-blue-700' : 'bg-white border-slate-100 text-slate-700 hover:bg-slate-50');
      btn.innerHTML = '<span class="truncate">' + escapeHtml(p.name) + '</span><span class="text-[10px] ' + (active ? 'text-blue-700' : 'text-slate-400') + '">' + count + '</span>';
      btn.onclick = function(){ setProjectFilter(p.id); };
      list.appendChild(btn);
    });

    hydrateSelectors();
  }

  function renderAll(){
    
    var container = document.getElementById('task-container');

    var tasks = state.data.tasks.slice().sort(function(a,b){
      if (state.data.ui.dateRange === 'undated') return (a.createdAt||'').localeCompare(b.createdAt||'');
      var ad = a.date || '9999-12-31';
      var bd = b.date || '9999-12-31';
      if (ad !== bd) return ad.localeCompare(bd);
      var sIdx = function(id){ return state.data.sections.findIndex(function(s){ return s.id===id; }); };
      var ai = sIdx(a.sectionId); var bi = sIdx(b.sectionId);
      if (ai !== bi) return ai - bi;
      return (Number(a.priority)||3) - (Number(b.priority)||3);
    }).filter(isVisibleByFilters);

    if (!tasks.length){
      container.innerHTML = '<div class="bg-white border rounded-3xl p-8 text-center">' +
        '<div class="text-3xl mb-2">ğŸ—‚ï¸</div>' +
        '<p class="font-bold text-slate-800">è¡¨ç¤ºã™ã‚‹ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</p>' +
        '<p class="text-sm text-slate-500 mt-1">å³ä¸‹ã®ï¼‹ã‹ã‚‰è¿½åŠ ã§ãã¾ã™</p>' +
        '</div>';
      recomputeTotals();
      return;
    }

    // date -> tasks
    var dateGroups = new Map();
    tasks.forEach(function(t){
      var dk = t.date || 'æœªè¨­å®š';
      if (!dateGroups.has(dk)) dateGroups.set(dk, []);
      dateGroups.get(dk).push(t);
    });

    container.innerHTML = '';

    dateGroups.forEach(function(dateItems, dateKey){
      var dateSection = document.createElement('section');
      dateSection.className = 'mb-10';

      var dateHeader = document.createElement('div');
      dateHeader.className = 'flex items-center justify-between mb-3';
      var label = (dateKey==='æœªè¨­å®š') ? 'æœªè¨­å®š' : prettyDate(dateKey);
      dateHeader.innerHTML = '<h2 class="text-[11px] font-black text-slate-400 uppercase tracking-widest">' + escapeHtml(label) + '</h2>' +
        '<div class="text-[11px] text-slate-400">' + dateItems.length + 'ä»¶</div>';

      // section -> tasks
      var bySection = new Map();
      dateItems.forEach(function(t){
        var sid = t.sectionId || 'unknown';
        if (!bySection.has(sid)) bySection.set(sid, []);
        bySection.get(sid).push(t);
      });

      var list = document.createElement('div');
      list.className = 'space-y-6';
      
      // âœ… â€œã‚¿ã‚¹ã‚¯ãŒãªãã¦ã‚‚æ™‚é–“æ ã‚’è¡¨ç¤ºâ€ ã®ãŸã‚ã€sectionsé †ã§å¿…ãšå›ã™
      var sectionOrder = state.data.sections.map(function(s){ return s.id; });
      sectionOrder.forEach(function(sid){
        var sectionItems = bySection.get(sid) || [];
        var seName = (sid==='unknown') ? 'ï¼ˆæœªåˆ†é¡ï¼‰' : ((getSection(sid) && getSection(sid).name) ? getSection(sid).name : 'ï¼ˆæœªåˆ†é¡ï¼‰');
        var secEst = sectionItems.reduce(function(a,t){ return a + (Number(t.estimateMin)||0); }, 0);
        var secAct = sectionItems.reduce(function(a,t){
        var base = Number(t.actualMin)||0;
        var extra = (t.status==='running' && t.startedAt) ? elapsedMinSince(t.startedAt) : 0;
        return a + base + extra;
        }, 0);
        var secInterrupt = sectionItems.filter(function(t){ return !!t.isInterrupt; }).length;

        var header = document.createElement('div');
        header.className = 'flex items-center justify-between px-1';
        header.innerHTML = '<div class="flex items-center gap-2">' +
          '<span class="text-xs font-black text-slate-700">' + escapeHtml(seName) + '</span>' +
          '<span class="text-[10px] font-bold px-2 py-0.5 rounded-full bg-slate-100 text-slate-600">' + sectionItems.length + 'ä»¶</span>' +
          (secInterrupt ? '<span class="text-[10px] font-black px-2 py-0.5 rounded-full bg-rose-100 text-rose-700">å‰²ã‚Šè¾¼ã¿ ' + secInterrupt + '</span>' : '') +
          '</div>' +
          '<div class="text-[11px] text-slate-500">è¦‹ç© ' + fmtMin(secEst) + ' / å®Ÿç¸¾ ' + fmtMin(secAct) + '</div>';

        var cards = document.createElement('div');
        cards.className = 'space-y-3';
  // âœ… ç©ºæ ã§ã‚‚è¡¨ç¤ºï¼ˆè»½ã„ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ï¼‰
        if (!sectionItems.length){
          var empty = document.createElement('div');
          empty.className = 'bg-white/60 border border-dashed border-slate-200 rounded-2xl p-4 text-xs text-slate-400';
          empty.textContent = 'ã‚¿ã‚¹ã‚¯ãªã—';
          cards.appendChild(empty);
        }
        sectionItems.forEach(function(t){
          var pj = (getProject(t.projectId) && getProject(t.projectId).name) ? getProject(t.projectId).name : 'â€”';
          var elapsed = (t.status==='running') ? elapsedMinSince(t.startedAt) : 0;

          var card = document.createElement('div');
          card.className = 'task-card bg-white border border-slate-100 rounded-3xl p-5 transition cursor-pointer ' + statusClass(t);
          // âœ… ãƒšãƒ³å»ƒæ­¢ï¼šã‚«ãƒ¼ãƒ‰æœ¬ä½“ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«
          card.onclick = function(){ openTaskModal(t.id); };
          card.innerHTML = '<div class="flex items-start justify-between gap-3">' +
            '<div class="min-w-0">' +
              '<div class="flex items-center gap-2 flex-wrap">' +
                '<p class="font-bold text-slate-800 truncate">' + escapeHtml(t.name || '(ç„¡é¡Œ)') + '</p>' +
                (t.isInterrupt ? '<span class="text-[10px] font-black px-2 py-0.5 rounded-full bg-rose-100 text-rose-700">å‰²ã‚Šè¾¼ã¿</span>' : '') +
                priorityBadge(t.priority) +
                 (t.status==='running'
                  ? '<span data-elapsed-task-id="' + t.id + '" class="text-[10px] font-black px-2 py-0.5 rounded-full bg-blue-100 text-blue-700">çµŒé ' + elapsed + 'm</span>'
                   : '') +
              '</div>' +
              '<div class="mt-1 text-xs text-slate-500 flex flex-wrap gap-x-3 gap-y-1">' +
                '<span><i class="fa-regular fa-folder-open"></i> ' + escapeHtml(pj) + '</span>' +
                '<span><i class="fa-regular fa-hourglass"></i> è¦‹ç© ' + fmtMin(t.estimateMin) + '</span>' +
                '<span><i class="fa-regular fa-circle-check"></i> å®Ÿç¸¾ ' + fmtMin(t.actualMin) + '</span>' +
              '</div>' +
            '</div>' +

            '<div class="task-actions flex items-center gap-2">' +
              (t.status === 'running'
                ? '<button onclick="event.stopPropagation(); pauseTask(\'' + t.id + '\')" class="p-2 rounded-xl border hover:bg-slate-50" title="ä¸­æ–­ï¼ˆåœæ­¢ï¼‰" aria-label="pause"><i class="fas fa-pause text-amber-600"></i></button>'
                : '<button onclick="event.stopPropagation(); startTask(\'' + t.id + '\')" class="p-2 rounded-xl border hover:bg-slate-50" title="é–‹å§‹ï¼ˆå†ç”Ÿï¼‰" aria-label="start"><i class="fas fa-play text-blue-600"></i></button>'
              ) +

              // âœ… ä¸€è¦§ã¯æœ€å°æ§‹æˆï¼šå†ç”Ÿ/åœæ­¢ + å®Œäº†
               '<button onclick="event.stopPropagation(); toggleComplete(\'' + t.id + '\')" class="p-2 rounded-xl border hover:bg-slate-50" title="å®Œäº†" aria-label="toggle complete">' +
               '<i class="fas ' + (t.status==='completed' ? 'fa-rotate-left text-slate-500' : 'fa-check text-emerald-600') + '"></i>' +
             '</button>' +
            '</div>' +
          '</div>' +

          '<div class="mt-4 bg-slate-50 border border-slate-100 rounded-2xl p-3">' +
            '<p class="text-xs text-slate-700 whitespace-pre-wrap">' + escapeHtml(t.notes || '') + '</p>' +
          '</div>';

          cards.appendChild(card);
        });

        var block = document.createElement('div');
        block.className = 'space-y-3';
        block.appendChild(header);
        block.appendChild(cards);
        list.appendChild(block);
      });

      dateSection.appendChild(dateHeader);
      dateSection.appendChild(list);
      container.appendChild(dateSection);
    });
    recomputeTotals();
  }
 
  function tickRunningUI(){
  // running ã®çµŒéè¡¨ç¤ºã ã‘æ›´æ–°
  state.data.tasks.forEach(function(t){
    if (t.status !== 'running' || !t.startedAt) return;
    var el = document.querySelector('[data-elapsed-task-id="'+ t.id +'"]');
    if (!el) return;
    el.textContent = 'çµŒé ' + elapsedMinSince(t.startedAt) + 'm';
  });

    // ãƒ˜ãƒƒãƒ€ãƒ¼ã®å®Ÿç¸¾åˆè¨ˆã‚‚æ›´æ–°ï¼ˆrenderAllãªã—ã§ï¼‰
    recomputeTotals();
  }
  /*********************
   * 11) CRUD
   *********************/
  function openTaskModal(taskId, isInterrupt){
    taskId = taskId || null;
    isInterrupt = !!isInterrupt;

    var t = taskId ? state.data.tasks.find(function(x){ return x.id===taskId; }) : null;

    document.getElementById('modal-title').textContent = taskId ? 'ã‚¿ã‚¹ã‚¯ç·¨é›†' : 'ã‚¿ã‚¹ã‚¯è¿½åŠ ';
    document.getElementById('task-id').value = (t && t.id) ? t.id : '';
    document.getElementById('task-is-interrupt').value = ((t && t.isInterrupt) || isInterrupt) ? '1' : '';

    var defaultSection = 'afternoon';
    var defaultDate = nowISODate();

    document.getElementById('task-name').value = (t && t.name) ? t.name : '';
    document.getElementById('task-section').value = (t && t.sectionId) ? t.sectionId : defaultSection;
    document.getElementById('task-project').value = (t && t.projectId) ? t.projectId : 'inbox';

    document.getElementById('task-duration').value = (t && t.estimateMin != null) ? t.estimateMin : 0;
    document.getElementById('task-deadline').value = t ? (t.date || '') : defaultDate;
    document.getElementById('task-repeat').value = (t && t.repeat) ? t.repeat : 'none';
    document.getElementById('task-status').value = (t && t.status) ? t.status : 'pending';
    document.getElementById('task-actual').value = (t && t.actualMin != null) ? t.actualMin : 0;
    document.getElementById('task-priority').value = String((t && t.priority != null) ? t.priority : 3);
    document.getElementById('task-notes').value = (t && t.notes) ? t.notes : '';

    openModal('task-modal');
    setTimeout(function(){ document.getElementById('task-name').focus(); }, 50);
  }

  async function saveTaskFromModal(){
    var id = document.getElementById('task-id').value || uid();
    var isInterrupt = !!document.getElementById('task-is-interrupt').value;

    var name = document.getElementById('task-name').value.trim();
    var sectionId = document.getElementById('task-section').value;
    var projectId = document.getElementById('task-project').value;
    var estimateMin = Number(document.getElementById('task-duration').value || 0);
    var dateRaw = document.getElementById('task-deadline').value || '';
    // âœ… date ã¯ã€Œå…¥åŠ›ã•ã‚ŒãŸå€¤ã‚’ãã®ã¾ã¾ä¿å­˜ã€
    // ï¼ˆæœªè¨­å®šã«ã—ãŸã„å ´åˆã¯ input ã‚’ç©ºã«ã—ã¦ä¿å­˜ã™ã‚‹ï¼‰
    var date = dateRaw;
    var repeat = document.getElementById('task-repeat').value;
    var status = document.getElementById('task-status').value;
    var actualMin = Number(document.getElementById('task-actual').value || 0);
    var priority = Number(document.getElementById('task-priority').value || 3);
    var notes = document.getElementById('task-notes').value.trim();

    if (!name){ toast('ã‚¿ã‚¹ã‚¯åãŒå¿…è¦ã§ã™'); return; }
    if (!notes){ toast('å‚™è€ƒã¯å¿…é ˆã§ã™'); return; }

    var idx = state.data.tasks.findIndex(function(t){ return t.id===id; });

    var base = {
      id: id,
      name: name,
      sectionId: sectionId,
      projectId: projectId,
      estimateMin: Math.max(0, estimateMin),
      actualMin: Math.max(0, actualMin),
      date: date || '',
      repeat: repeat,
      status: status,
      priority: priority,
      isInterrupt: isInterrupt,
      notes: notes,
      startedAt: (status === 'running') ? (new Date().toISOString()) : null,
      updatedAt: new Date().toISOString(),
    };

    if (idx >= 0){
      var prev = state.data.tasks[idx];
      // â˜…è¿½åŠ ï¼šrunning â†’ érunning ã«å¤‰ãˆã‚‹ãªã‚‰ã€ä¿å­˜å‰ã«ç²¾ç®—
      if (prev.status === 'running' && base.status !== 'running') {
       var add = elapsedMinSince(prev.startedAt);
      base.actualMin = Math.max(0, Number(prev.actualMin || 0) + add);
      base.startedAt = null;
    }
      if (prev.status === 'running' && base.status === 'running') base.startedAt = prev.startedAt;
      state.data.tasks[idx] = Object.assign({}, prev, base);
      toast('ä¿å­˜ã—ã¾ã—ãŸ');
    } else {
      state.data.tasks.push(Object.assign({}, base, { createdAt: new Date().toISOString() }));
      toast('è¿½åŠ ã—ã¾ã—ãŸ');
    }

    await persist();
    closeModal('task-modal');
setDateRange(state.data.ui.dateRange || 'today', true);
  }

  async function toggleComplete(taskId){
    var t = state.data.tasks.find(function(x){ return x.id===taskId; });
    if (!t) return;

    // âœ… è¦ä»¶: å®Œäº†ã€ã‚’æŠ¼ã™ã¨ running ãªã‚‰çµŒéåˆ†ã‚’ actualMin ã«åŠ ç®—ã—ã¦ã‹ã‚‰ completed
    if (t.status === 'completed'){
      // æ—¢å­˜ã®ã€Œæˆ»ã™ã€ã¯ç¶­æŒï¼ˆpendingã¸ï¼‰
      setTaskStatus(t, 'pending');
    } else {
      if (t.status === 'running') finalizeRunningIfNeeded(t);
      setTaskStatus(t, 'completed');
    }
    await persist();
    renderAll();
  }

  async function deleteTask(taskId){
    if (!confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    state.data.tasks = state.data.tasks.filter(function(t){ return t.id!==taskId; });
    await persist();
    toast('å‰Šé™¤ã—ã¾ã—ãŸ');
    renderAll();
  }

  // âœ… ãƒ¢ãƒ¼ãƒ€ãƒ«å†…æ“ä½œï¼ˆä¸€è¦§ã‹ã‚‰ç§»å‹•ã—ãŸåˆ†ï¼‰
  function getModalTaskId(){ return document.getElementById('task-id').value || null; }
  async function deleteTaskFromModal(){
    var id = getModalTaskId();
    if (!id){ toast('ä¿å­˜å¾Œã«å‰Šé™¤ã§ãã¾ã™'); return; }
    await deleteTask(id);
    closeModal('task-modal');
  }
  async function postponeTaskFromModal(days){
    var id = getModalTaskId();
    if (!id){ toast('ä¿å­˜å¾Œã«å…ˆé€ã‚Šã§ãã¾ã™'); return; }
    await postponeTask(id, days || 1);
    closeModal('task-modal');
  }
  async function loopTaskFromModal(){
    var id = getModalTaskId();
    if (!id){ toast('ä¿å­˜å¾Œã«ãƒ«ãƒ¼ãƒ—ã§ãã¾ã™'); return; }
    await loopTask(id);
    closeModal('task-modal');
  }
  function openProjectModal(projectId){
    projectId = projectId || null;
    var p = projectId ? state.data.projects.find(function(x){ return x.id===projectId; }) : null;
    document.getElementById('project-id').value = p ? p.id : '';
    document.getElementById('project-name').value = p ? p.name : '';
    openModal('project-modal');
    setTimeout(function(){ document.getElementById('project-name').focus(); }, 50);
  }

  async function saveProjectFromModal(){
    var id = document.getElementById('project-id').value || uid();
    var name = document.getElementById('project-name').value.trim();
    if (!name){ toast('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåãŒå¿…è¦ã§ã™'); return; }

    var dup = state.data.projects.find(function(p){ return p.name===name && p.id!==id; });
    if (dup){ toast('åŒåãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚Šã¾ã™'); return; }

    var idx = state.data.projects.findIndex(function(p){ return p.id===id; });
    if (idx>=0) state.data.projects[idx].name = name;
    else state.data.projects.push({ id: id, name: name });

    await persist();
    closeModal('project-modal');
    renderProjects();
    toast('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¿å­˜');
  }

  /*********************
   * 12) Export / Backup
   *********************/
  function exportToCSV(){
    var rows = [[ 'id','name','project','section','estimateMin','actualMin','date','repeat','status','priority','isInterrupt','notes','createdAt','updatedAt','startedAt' ]];
    state.data.tasks.forEach(function(t){
      rows.push([
        t.id,
        t.name,
        (getProject(t.projectId) && getProject(t.projectId).name) ? getProject(t.projectId).name : '',
        (getSection(t.sectionId) && getSection(t.sectionId).name) ? getSection(t.sectionId).name : '',
        t.estimateMin ?? 0,
        t.actualMin ?? 0,
        t.date || '',
        t.repeat || 'none',
        t.status || 'pending',
        t.priority ?? 3,
        t.isInterrupt ? 1 : 0,
        String(t.notes||'').replaceAll('\n','\\n'),
        t.createdAt || '',
        t.updatedAt || '',
        t.startedAt || ''
      ]);
    });

    var csv = rows.map(function(r){
      return r.map(function(v){
        var s = String(v ?? '');
        return (s.includes(',') || s.includes('"') || s.includes('\n')) ? '"' + s.replaceAll('"','""') + '"' : s;
      }).join(',');
    }).join('\n');

    var blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'taskchute_' + nowISODate() + '.csv';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
  }

  function backupJSON(){
    var blob = new Blob([JSON.stringify(state.data, null, 2)], {type:'application/json'});
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'taskchute_backup_' + nowISODate() + '.json';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
  }

  async function restoreJSON(event){
    var file = event.target.files && event.target.files[0];
    if (!file) return;
    try {
      var text = await file.text();
      var obj = JSON.parse(text);
      state.data = normalizeData(obj);
      await persist();
      hydrateSelectors();
      renderProjects();
      renderAll();
      toast('å¾©å…ƒã—ã¾ã—ãŸ');
    } catch {
      toast('å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ');
    } finally {
      event.target.value = '';
    }
  }

  async function clearData(){
    if (!confirm('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
    await storage.clear();
    location.reload();
  }

  /*********************
   * 13) Tests
   *********************/
  function assert(cond, msg){ if (!cond) throw new Error(msg || 'assertion failed'); }

  function runTests(){
    try {
      var snapshot = JSON.parse(JSON.stringify(state.data));
      state.data.tasks = [];
      var today = nowISODate();

      state.data.tasks.push({
        id: 't1', name: 'A', sectionId: 'morning', projectId: 'inbox', estimateMin: 10, actualMin: 0,
        date: today, repeat: 'none', status: 'pending', priority: 3, isInterrupt: false,
        notes: 'ok', createdAt: new Date().toISOString(), updatedAt: new Date().toISOString(), startedAt: null
      });
      state.data.tasks.push({
        id: 't2', name: 'B', sectionId: 'morning', projectId: 'inbox', estimateMin: 5, actualMin: 0,
        date: today, repeat: 'none', status: 'running', priority: 3, isInterrupt: true,
        notes: 'ok', createdAt: new Date().toISOString(), updatedAt: new Date().toISOString(), startedAt: new Date(Date.now()-5*60000).toISOString()
      });

      state.data.ui.dateRange = 'today';
      document.getElementById('filter-completed').checked = true;
      document.getElementById('filter-uncompleted-only').checked = false;
      renderAll();

      assert(document.querySelector('[aria-label="start"]') !== null, 'start button should exist');
      // âœ… å®Ÿç¸¾åˆè¨ˆã« running ã®çµŒéãŒåŠ å‘³ã•ã‚Œã‚‹
      var actualText = document.getElementById('total-actual').textContent;
      // t2 ã¯ 5åˆ†çµŒéï¼ˆactualMin=0, startedAt=now-5minï¼‰ãªã®ã§ 0h 05m ãŒæœŸå¾…å€¤
      // â€» fmtMin ã¯ "0h 05m" å½¢å¼
      assert(actualText.includes('0h 05m') || actualText.includes('0h 06m') || actualText.includes('0h 04m'), 'total-actual should include running elapsed');
 
      var evening = new Date();
      evening.setHours(19,0,0,0);
      enforceEveningRule(evening);
      var moved = state.data.tasks.find(function(x){ return x.id==='t2'; });
      assert(moved.status !== 'running', 'running should stop at evening');
      assert(moved.sectionId === 'morning', 'evening move should set morning');
      assert(moved.date === addDaysISO(today, 1), 'evening move should postpone +1 day');

      // loop
      loopTask('t1');
      var created = state.data.tasks.find(function(x){ return x.name==='A' && x.id!=='t1' && x.status==='running'; });
      assert(!!created, 'loop should create a new running task');
      assert(created.sectionId === 'forenoon', 'loop should set forenoon');

      state.data = snapshot;
      hydrateSelectors();
      renderProjects();
      renderAll();
      toast('ãƒ†ã‚¹ãƒˆOK');
    } catch (e){
      console.error('Tests failed', e);
      toast('ãƒ†ã‚¹ãƒˆå¤±æ•—: ' + (e && e.message ? e.message : e));
    }
  }

  /*********************
   * 14) Boot + ticker
   *********************/
  var runningInterval = null;
 function startTicker(){
  if (runningInterval) return;
  enforceEveningRule(new Date());
  runningInterval = setInterval(function(){
    enforceEveningRule(new Date());
    var hasRunning = state.data.tasks.some(function(t){
      return t.status === 'running';
    });
    if (hasRunning) tickRunningUI();
  }, 30 * 1000);
}

  async function loadApp(){
    await refreshAuthChip();

    // Supabaseè¨­å®šãªã—ãªã‚‰ãƒ­ãƒ¼ã‚«ãƒ«ã§å‹•ã‹ã™
    if (!supabaseClient){
      var loadedLocal = await localAdapter.load();
      if (loadedLocal) state.data = normalizeData(loadedLocal);
      else {
        var today = nowISODate();
        state.data.tasks = [{
          id: uid(),
          name: 'ï¼ˆä¾‹ï¼‰ä»Šæ—¥ã®è¨ˆç”»ã‚’ç«‹ã¦ã‚‹',
          sectionId: 'morning',
          projectId: 'inbox',
          estimateMin: 15,
          actualMin: 0,
          date: today,
          repeat: 'none',
          status: 'pending',
          priority: 3,
          isInterrupt: false,
          notes: 'å‚™è€ƒãŒå¿…é ˆã§ã™ã€‚ã“ã“ã«åˆ¤æ–­ãƒ¡ãƒ¢ã‚„æ¡ä»¶ã‚’æ›¸ãã¾ã™ã€‚',
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString(),
          startedAt: null,
        }];
        await localAdapter.save(state.data);
      }

      hydrateSelectors();
      renderProjects();
      setDateRange(state.data.ui.dateRange || 'today', true);
      renderAll();
      startTicker();
      return;
    }

    var loaded = await storage.load();
    if (loaded) state.data = normalizeData(loaded);
    else {
      var local = await localAdapter.load();
      if (local) {
        state.data = normalizeData(local);
        try { await storage.save(state.data); } catch {}
      } else {
        var today2 = nowISODate();
        state.data.tasks = [{
          id: uid(),
          name: 'ï¼ˆä¾‹ï¼‰ä»Šæ—¥ã®è¨ˆç”»ã‚’ç«‹ã¦ã‚‹',
          sectionId: 'morning',
          projectId: 'inbox',
          estimateMin: 15,
          actualMin: 0,
          date: today2,
          repeat: 'none',
          status: 'pending',
          priority: 3,
          isInterrupt: false,
          notes: 'å‚™è€ƒãŒå¿…é ˆã§ã™ã€‚ã“ã“ã«åˆ¤æ–­ãƒ¡ãƒ¢ã‚„æ¡ä»¶ã‚’æ›¸ãã¾ã™ã€‚',
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString(),
          startedAt: null,
        }];
        await persist();
      }
    }

    hydrateSelectors();
    renderProjects();
    setDateRange(state.data.ui.dateRange || 'today', true);
    renderAll();
    startTicker();

    supabaseClient.auth.onAuthStateChange(async function(){
      await refreshAuthChip();
      var loaded2 = await storage.load();
      if (loaded2) state.data = normalizeData(loaded2);
      renderProjects();
      renderAll();
    });
  }

  // âœ… HTMLã®onclickã‹ã‚‰å‘¼ã¹ã‚‹ã‚ˆã†ã«ã‚°ãƒ­ãƒ¼ãƒãƒ«å…¬é–‹
  window.toggleSidebar = toggleSidebar;
  window.switchSidebarTab = switchSidebarTab;
  window.openQuickSearch = openQuickSearch;
  window.openAuthModal = openAuthModal;
  window.closeModal = closeModal;

  window.setDateRange = setDateRange;
  window.setProjectFilter = setProjectFilter;

  window.openTaskModal = openTaskModal;
  window.saveTaskFromModal = saveTaskFromModal;
  window.toggleComplete = toggleComplete;
  window.deleteTask = deleteTask;

  window.openProjectModal = openProjectModal;
  window.saveProjectFromModal = saveProjectFromModal;

  window.startTask = startTask;
  window.pauseTask = pauseTask;
  window.postponeTask = postponeTask;
  window.loopTask = loopTask;
  window.deleteTaskFromModal = deleteTaskFromModal;
  window.postponeTaskFromModal = postponeTaskFromModal;
  window.loopTaskFromModal = loopTaskFromModal;

  window.exportToCSV = exportToCSV;
  window.backupJSON = backupJSON;
  window.restoreJSON = restoreJSON;
  window.clearData = clearData;

  window.authSignIn = authSignIn;
  window.authSignUp = authSignUp;
  window.authSignOut = authSignOut;
  window.migrateLocalToCloud = migrateLocalToCloud;

  window.renderAll = renderAll;
  window.runTests = runTests;

  // start
  loadApp();

})();
</script>
</body>
</html>
